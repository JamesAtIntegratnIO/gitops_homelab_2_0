global:
  domain: argocd.cluster.integratn.tech

# -- Horizontal + vertical scaling for the host cluster ArgoCD
controller:
  replicas: 2
  dynamicClusterDistribution: true
  resources:
    requests:
      cpu: 500m
      memory: 2Gi
    limits:
      cpu: "2"
      memory: 4Gi

server:
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 60
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  service:
    annotations:
      metallb.universe.tf/loadBalancerIPs: 10.0.4.201
  extensions:
    enabled: true
    extensionList:
      - name: extension-trivy
        env:
          - name: EXTENSION_URL
            value: https://github.com/mziyabo/argocd-trivy-extension/releases/download/v0.2.0/extension-trivy.tar
          - name: EXTENSION_CHECKSUM_URL
            value: https://github.com/mziyabo/argocd-trivy-extension/releases/download/v0.2.0/extension-trivy_checksums.txt

repoServer:
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 60
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: "1"
      memory: 1Gi

applicationSet:
  replicas: 2
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

redis:
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

configs:
  params:
    server.insecure: true
    server.url: https://argocd.cluster.integratn.tech
  
  cm:
    # Reduce reconciliation interval from 180s default to 30s
    # Ensures state store changes from Kratix are picked up quickly
    timeout.reconciliation: 30s

    # Authentik OIDC configuration
    oidc.config: |
      name: Authentik
      issuer: https://auth.cluster.integratn.tech/application/o/argocd/
      clientID: $argocd-oidc-config:client-id
      clientSecret: $argocd-oidc-config:client-secret
      requestedScopes:
        - openid
        - profile
        - email
        - groups
    # Ignore container resource drift â€” VPA Auto mode manages requests/limits
    resource.customizations.ignoreDifferences.apps_Deployment: |
      jqPathExpressions:
        - .spec.template.spec.containers[].resources
        - .spec.template.spec.initContainers[]?.resources
    resource.customizations.ignoreDifferences.apps_StatefulSet: |
      jqPathExpressions:
        - .spec.template.spec.containers[].resources
        - .spec.template.spec.initContainers[]?.resources
    resource.customizations.ignoreDifferences.apps_DaemonSet: |
      jqPathExpressions:
        - .spec.template.spec.containers[].resources
        - .spec.template.spec.initContainers[]?.resources
    # Custom health check for ApplicationSet (ArgoCD doesn't include one by default)
    resource.customizations.health.argoproj.io_ApplicationSet: |
      hs = {}
      hs.status = "Healthy"
      hs.message = "ApplicationSet is running"
      return hs

    # Local account for AI MCP platform (API key only, no UI login)
    accounts.mcp-readonly: apiKey
    accounts.mcp-readonly.enabled: "true"
  
  rbac:
    policy.csv: |
      # Default policy: read-only for authenticated users
      p, role:readonly, applications, get, */*, allow
      p, role:readonly, certificates, get, *, allow
      p, role:readonly, clusters, get, *, allow
      p, role:readonly, repositories, get, *, allow
      p, role:readonly, projects, get, *, allow
      p, role:readonly, accounts, get, *, allow
      p, role:readonly, gpgkeys, get, *, allow
      g, role:readonly, role:readonly
      
      # MCP AI platform read-only account
      p, role:mcp-readonly, applications, get, */*, allow
      p, role:mcp-readonly, clusters, get, *, allow
      p, role:mcp-readonly, projects, get, *, allow
      p, role:mcp-readonly, repositories, get, *, allow
      p, role:mcp-readonly, logs, get, */*, allow
      g, mcp-readonly, role:mcp-readonly
      
      # Map Authentik Admins group to ArgoCD admin role
      g, authentik Admins, role:admin

dex:
  enabled: false

extraObjects:
  - apiVersion: gateway.networking.k8s.io/v1
    kind: HTTPRoute
    metadata:
      name: argocd
      namespace: argocd
    spec:
      parentRefs:
        - name: nginx-gateway
          namespace: nginx-gateway
          sectionName: https
      hostnames:
        - argocd.cluster.integratn.tech
      rules:
        - matches:
            - path:
                type: PathPrefix
                value: /
          backendRefs:
            - name: argo-cd-argocd-server
              port: 80
  - apiVersion: gateway.networking.k8s.io/v1
    kind: HTTPRoute
    metadata:
      name: argocd-http-redirect
      namespace: argocd
    spec:
      parentRefs:
        - name: nginx-gateway
          namespace: nginx-gateway
          sectionName: http
      hostnames:
        - argocd.cluster.integratn.tech
      rules:
        - filters:
            - type: RequestRedirect
              requestRedirect:
                scheme: https
                statusCode: 301
          matches:
            - path:
                type: PathPrefix
                value: /