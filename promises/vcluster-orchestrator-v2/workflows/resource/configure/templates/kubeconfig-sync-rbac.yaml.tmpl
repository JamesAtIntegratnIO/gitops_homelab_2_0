---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ .Name }}-onepassword-token
  namespace: {{ .TargetNamespace }}
  labels:
    app.kubernetes.io/name: external-secret
    app.kubernetes.io/component: kubeconfig-sync
    app.kubernetes.io/managed-by: kratix
    kratix.io/promise-name: {{ .WorkflowContext.PromiseName }}
    kratix.io/resource-name: {{ .Name }}
spec:
  secretStoreRef:
    name: onepassword-store
    kind: ClusterSecretStore
  target:
    name: vcluster-{{ .Name }}-onepassword-token
  data:
    - secretKey: token
      remoteRef:
        key: onepassword-access-token
        property: credential
    - secretKey: vault
      remoteRef:
        key: onepassword-access-token
        property: vault
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ .Name }}-kubeconfig-sync
  namespace: {{ .TargetNamespace }}
  labels:
    app.kubernetes.io/name: kubeconfig-sync
    app.kubernetes.io/managed-by: kratix
    kratix.io/promise-name: {{ .WorkflowContext.PromiseName }}
    kratix.io/resource-name: {{ .Name }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ .Name }}-kubeconfig-sync
  namespace: {{ .TargetNamespace }}
  labels:
    app.kubernetes.io/name: kubeconfig-sync
    app.kubernetes.io/managed-by: kratix
    kratix.io/promise-name: {{ .WorkflowContext.PromiseName }}
    kratix.io/resource-name: {{ .Name }}
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    resourceNames: ["vc-{{ .Name }}", "vcluster-{{ .Name }}-onepassword-token"]
    verbs: ["get"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ .Name }}-kubeconfig-sync
  namespace: {{ .TargetNamespace }}
  labels:
    app.kubernetes.io/name: kubeconfig-sync
    app.kubernetes.io/managed-by: kratix
    kratix.io/promise-name: {{ .WorkflowContext.PromiseName }}
    kratix.io/resource-name: {{ .Name }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ .Name }}-kubeconfig-sync
subjects:
  - kind: ServiceAccount
    name: {{ .Name }}-kubeconfig-sync
    namespace: {{ .TargetNamespace }}
