# VCluster Orchestrator V2 Promise

**Go SDK Implementation - Consolidated Architecture**

This is the v2 implementation of the vcluster-orchestrator promise, migrated from bash scripts with heredocs to the Kratix Go SDK with proper templates.

## Key Improvements Over V1

### Architecture Consolidation
- **V1**: 8 separate promise executions (orchestrator + 7 sub-promises)
- **V2**: 3 promise executions (orchestrator generates resources directly + 2 reusable ArgoCD promises)

### Consolidated Sub-Promises (Generated Directly)
The following sub-promise logic is now built into the orchestrator:
1. **vcluster-coredns**: CoreDNS ConfigMap
2. **vcluster-kubeconfig-sync**: Job + RBAC + ExternalSecret for 1Password sync
3. **vcluster-kubeconfig-external-secret**: ExternalSecret for kubeconfig retrieval
4. **vcluster-argocd-cluster-registration**: ExternalSecret for ArgoCD cluster secret

### Retained as ResourceRequests (Reusable)
These remain as separate promises for reusability:
- **argocd-project**: Generic ArgoCD project creation
- **argocd-application**: Generic ArgoCD application creation

## Pipeline Implementation

### Technology Stack
- **Language**: Go 1.23
- **Framework**: Kratix Go SDK v0.1.0
- **Templating**: Go templates with YAML generation
- **Container**: Multi-stage Docker build (golang:1.23-alpine → alpine:3.19)

### Pipeline Structure
```
workflows/resource/configure/
├── main.go                          # Go SDK pipeline logic
├── go.mod                            # Go module definition
├── Dockerfile                        # Multi-stage container build
└── templates/                        # YAML templates
    ├── argocd-project-request.yaml
    ├── argocd-application-request.yaml
    ├── coredns-configmap.yaml
    ├── kubeconfig-sync-rbac.yaml
    ├── kubeconfig-sync-job.yaml
    ├── kubeconfig-external-secret.yaml
    └── argocd-cluster-external-secret.yaml
```

## Security Model

**CRITICAL**: No `kind: Secret` resources are generated. All credentials use `ExternalSecret` with 1Password Connect.

### Secret Flow
1. **Kubeconfig Sync Job**: Reads `vc-{name}` secret (generated by vcluster), syncs to 1Password
2. **Kubeconfig ExternalSecret**: Pulls kubeconfig from 1Password for host cluster access
3. **ArgoCD Cluster ExternalSecret**: Pulls ArgoCD cluster registration data from 1Password
4. **OnePassword Token**: ExternalSecret references ClusterSecretStore for Connect API token

## Resource Generation

### Configuration Parsing
- Extracts 40+ spec fields from ResourceRequest
- Applies preset-based defaults (dev vs prod)
- Calculates VIP from CIDR subnet if not specified
- Validates VIP within subnet boundaries
- Builds complete Helm values YAML for vcluster

### Output Resources (7 total)
1. **ArgoCDProject ResourceRequest** → Kratix schedules to control-plane
2. **ArgoCDApplication ResourceRequest** → Kratix schedules to control-plane  
3. **CoreDNS ConfigMap** → Applied to target namespace
4. **ExternalSecret (OP token)** → Applied to target namespace
5. **ServiceAccount + Role + RoleBinding** → Applied to target namespace
6. **Kubeconfig Sync Job** → Applied to target namespace
7. **Kubeconfig ExternalSecret** → Applied to target namespace
8. **ArgoCD Cluster ExternalSecret** → Applied to argocd namespace

## Building & Deploying

### Build Container
```bash
cd promises/vcluster-orchestrator-v2/workflows/resource/configure
docker build -t ghcr.io/jamesatintegratnio/vcluster-orchestrator-v2-configure:latest .
docker push ghcr.io/jamesatintegratnio/vcluster-orchestrator-v2-configure:latest
```

### Install Promise
```bash
kubectl apply -f promises/vcluster-orchestrator-v2/promise.yaml
```

### Verify Installation
```bash
kubectl get promises vcluster-orchestrator-v2
kubectl get crd vclusterorchestratorv2s.platform.integratn.tech
```

## Migration Strategy (Zero Downtime)

### Phase 2: Testing
1. Create test ResourceRequest: `platform/vclusters/test.yaml`
2. Verify all resources generated correctly
3. Test kubeconfig sync to 1Password
4. Test ArgoCD cluster registration
5. Validate vcluster functionality

### Phase 3: Production Migration
**CRITICAL**: media vcluster is production - zero downtime required

#### Option A: In-Place Update (Safer)
```yaml
# platform/vclusters/media.yaml
apiVersion: platform.integratn.tech/v1alpha1
kind: VClusterOrchestratorV2  # Change from VClusterOrchestrator
# Keep all spec fields identical
```

Kratix will:
- Recognize spec changes
- Re-run configure pipeline with v2 image
- Generate new resources (ConfigMaps, Jobs, ExternalSecrets)
- ArgoCD will detect drift and sync

#### Option B: Blue-Green (More Complex)
1. Deploy new media-v2 vcluster
2. Migrate workloads
3. Update DNS/ingress
4. Decommission media v1

**Recommendation**: Option A with careful testing

### Phase 4: Cleanup
After migration validation (7+ days):
1. Remove v1 promise: `kubectl delete promise vcluster-orchestrator`
2. Archive sub-promises: `promises/_archived/`
3. Update documentation

## Preset Defaults

### Dev Preset
- **Replicas**: 1
- **CPU Request**: 200m
- **Memory Request**: 512Mi
- **CPU Limit**: 1000m
- **Memory Limit**: 1Gi
- **Persistence**: Disabled
- **CoreDNS Replicas**: 1

### Prod Preset
- **Replicas**: 3
- **CPU Request**: 500m
- **Memory Request**: 1Gi
- **CPU Limit**: 2
- **Memory Limit**: 2Gi
- **Persistence**: Enabled (10Gi)
- **CoreDNS Replicas**: 2

## Troubleshooting

### Pipeline Failures
```bash
# Check pipeline pod logs
kubectl logs -n platform-requests -l kratix.io/promise-name=vcluster-orchestrator-v2

# Check resource status
kubectl get vclusterorchestratorv2s -A
kubectl describe vclusterorchestratorv2 <name> -n <namespace>
```

### Kubeconfig Sync Issues
```bash
# Check job status
kubectl get jobs -n <target-namespace> | grep kubeconfig-sync

# Check job logs
kubectl logs -n <target-namespace> job/<name>-kubeconfig-sync

# Verify 1Password item
# (requires op CLI with vault access)
op item get vcluster-<name>-kubeconfig --vault homelab
```

### ArgoCD Registration Issues
```bash
# Check ExternalSecret status
kubectl get externalsecret -n <target-namespace> <name>-argocd-cluster

# Check generated cluster secret in argocd namespace
kubectl get secret -n argocd cluster-<name>-integratn-tech

# Verify in ArgoCD UI
argocd cluster list
```

## Development Notes

### Template Rendering
- Uses Go templates with custom functions: `toYaml`, `indent`, `toBool`
- YAML validation before writing output
- Structured logging with context

### IP Utilities
- `defaultVIPFromCIDR(cidr, offset)`: Calculates .100 IP in subnet by default
- `ipInCIDR(ip, cidr)`: Validates IP within subnet
- `ipToInt`, `intToIP`: Conversion helpers for calculations

### Error Handling
- Validates all required fields from ResourceRequest
- Returns descriptive errors for missing/invalid data
- Fails fast on template parse/render errors

## Related Documentation
- [Architecture Overview](../../docs/architecture.md)
- [Promise Development Guide](../../docs/promises.md)
- [VCluster Operations](../../docs/vclusters.md)
- [Migration Prompt](../../vcluster-promise-go-sdk-migration.prompt.md)
