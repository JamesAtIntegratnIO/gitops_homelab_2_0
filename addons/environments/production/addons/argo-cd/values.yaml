addPrometheusAnnotations: true
server:
  autoscaling:
    enabled: true
    minReplicas: 1
    maxReplicas: 5
    targetCPUUtilizationPercentage: 60
    
  service:
    annotations:
      metallb.io/address-pool: default
  ingress:
    enabled: false
    ingressClassName: nginx
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
    tls: true
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
controller:
  metrics:
    enabled: true
    applicationLabels:
      enabled: true
    serviceMonitor:
      enabled: true
dex:
  enabled: true
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

repoServer:
  autoscaling:
    enabled: true
    minReplicas: 1
    maxReplicas: 5
    targetCPUUtilizationPercentage: 60
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

applicationSet:
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

notifications:
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

  # -- Alertmanager notification service
  notifiers:
    service.alertmanager: |
      targets:
        - kube-prometheus-stack-alertmanager.monitoring.svc.cluster.local:9093
      scheme: http
      apiPath: /api/v2/alerts

  # -- Notification templates for Alertmanager
  templates:
    template.app-sync-failed: |
      alertmanager:
        labels:
          alertname: ArgoCD-AppSyncFailed
          severity: critical
          source: argocd-notifications
          app_name: "{{.app.metadata.name}}"
          project: "{{.app.spec.project}}"
          dest_namespace: "{{.app.spec.destination.namespace}}"
        annotations:
          summary: "Application {{.app.metadata.name}} sync failed"
          description: "Sync operation for {{.app.metadata.name}} (project: {{.app.spec.project}}) failed with phase {{.app.status.operationState.phase}}."
        generatorURL: "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}"

    template.app-health-degraded: |
      alertmanager:
        labels:
          alertname: ArgoCD-AppHealthDegraded
          severity: warning
          source: argocd-notifications
          app_name: "{{.app.metadata.name}}"
          project: "{{.app.spec.project}}"
          dest_namespace: "{{.app.spec.destination.namespace}}"
        annotations:
          summary: "Application {{.app.metadata.name}} health degraded"
          description: "Application {{.app.metadata.name}} (project: {{.app.spec.project}}) health status is {{.app.status.health.status}}."
        generatorURL: "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}"



  # -- Triggers that define when notifications are sent
  # oncePer deduplicates: only one alert per app until it recovers.
  # health-degraded requires the sync to not be actively running to avoid
  # transient degradation noise during rollouts.
  triggers:
    trigger.on-sync-failed: |
      - when: app.status.operationState != nil and app.status.operationState.phase in ['Error', 'Failed']
        oncePer: app.metadata.name
        send: [app-sync-failed]
    trigger.on-health-degraded: |
      - when: app.status.health.status == 'Degraded' and (app.status.operationState == nil or app.status.operationState.phase not in ['Running'])
        oncePer: app.metadata.name
        send: [app-health-degraded]


  # -- Default subscriptions - all apps get these triggers via Alertmanager
  subscriptions:
    - recipients:
        - alertmanager
      triggers:
        - on-sync-failed
        - on-health-degraded

redis:
  enabled: true
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

configs:
  cm:
    kustomize.buildOptions: |
      --enable-helm
    globalProjects: |
      - projectName: appteam-global
        labelSelector:
          matchExpressions:
            - key: argocd.argoproj.io/project-group
              operator: In
              values:
                - appteam
  params:
    server.insecure: true
