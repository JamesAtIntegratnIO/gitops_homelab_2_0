# authentik: Identity provider with server, worker, and Redis components
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: authentik
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
---
# Baseline: allow DNS for all pods in authentik
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns
  namespace: authentik
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
---
# Baseline: allow K8s API for controllers + webhook ingress from API server
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-kube-api
  namespace: authentik
spec:
  endpointSelector: {}
  ingress:
    - fromEntities:
        - kube-apiserver
        - remote-node
      toPorts:
        - ports:
            - port: "10250"
              protocol: TCP
  egress:
    - toEntities:
        - kube-apiserver
---
# Authentik Server: Allow ingress from nginx-gateway and Prometheus
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: authentik-server-ingress
  namespace: authentik
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: authentik
      app.kubernetes.io/component: server
  policyTypes:
    - Ingress
  ingress:
    # From nginx-gateway data plane for HTTPS traffic
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: nginx-gateway
          podSelector:
            matchLabels:
              app.kubernetes.io/name: nginx-gateway-nginx
      ports:
        - protocol: TCP
          port: 9443  # HTTPS
        - protocol: TCP
          port: 9000  # HTTP
    # From Prometheus for metrics scraping
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - protocol: TCP
          port: 9300
    # From Grafana for OIDC token exchange and userinfo
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
          podSelector:
            matchLabels:
              app.kubernetes.io/name: grafana
      ports:
        - protocol: TCP
          port: 9000
        - protocol: TCP
          port: 80
---
# Authentik Server: Allow egress to Redis and PostgreSQL
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: authentik-server-egress
  namespace: authentik
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: authentik
      app.kubernetes.io/component: server
  policyTypes:
    - Egress
  egress:
    # To Redis (internal)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: redis
      ports:
        - protocol: TCP
          port: 6379
    # To PostgreSQL (external at 10.0.3.0/24)
    - to:
        - ipBlock:
            cidr: 10.0.3.0/24
      ports:
        - protocol: TCP
          port: 5432
    # Allow egress to internet for external integrations (webhooks, email, etc.)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 587
        - protocol: TCP
          port: 25
---
# Authentik Worker: Allow ingress from Prometheus for metrics scraping
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: authentik-worker-ingress
  namespace: authentik
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: authentik
      app.kubernetes.io/component: worker
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - protocol: TCP
          port: 9300
---
# Authentik Worker: Allow egress to Redis and PostgreSQL
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: authentik-worker-egress
  namespace: authentik
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: authentik
      app.kubernetes.io/component: worker
  policyTypes:
    - Egress
  egress:
    # To Redis (internal)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: redis
      ports:
        - protocol: TCP
          port: 6379
    # To PostgreSQL (external at 10.0.3.0/24)
    - to:
        - ipBlock:
            cidr: 10.0.3.0/24
      ports:
        - protocol: TCP
          port: 5432
    # Allow egress to internet for external integrations (webhooks, email, etc.)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 587
        - protocol: TCP
          port: 25
---
# Redis: Allow ingress from Authentik server and worker
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis-ingress
  namespace: authentik
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: redis
  policyTypes:
    - Ingress
  ingress:
    # From Authentik server
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: authentik
              app.kubernetes.io/component: server
      ports:
        - protocol: TCP
          port: 6379
    # From Authentik worker
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: authentik
              app.kubernetes.io/component: worker
      ports:
        - protocol: TCP
          port: 6379
---
# Redis: Minimal egress (only DNS)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis-egress
  namespace: authentik
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: redis
  policyTypes:
    - Egress
  egress:
    # DNS already covered by baseline allow-dns policy
    []
