# Phase 2 Verification Guide

## Prerequisites

Before validation, ensure:

```bash
# 1. GitHub Actions workflow completed successfully
# Check: https://github.com/jamesatintegratnio/gitops_homelab_2_0/actions

# 2. Container image built and pushed
docker pull ghcr.io/jamesatintegratnio/vcluster-orchestrator-v2-configure:latest

# 3. Install the promise
kubectl apply -f promises/vcluster-orchestrator-v2/promise.yaml

# 4. Verify CRD installed
kubectl get crd vclusterorchestratorv2s.platform.integratn.tech

# 5. Verify promise ready
kubectl get promises vcluster-orchestrator-v2
```

## Deploy Test VCluster

```bash
# Apply the test vcluster resource
kubectl apply -f platform/vclusters/test.yaml

# Watch resource status
kubectl get vclusterorchestratorv2s -n platform-requests test -w
```

## Validation Checklist

### 1. Pipeline Execution

```bash
# Check pipeline pod logs
kubectl logs -n platform-requests -l kratix.io/promise-name=vcluster-orchestrator-v2 -f

# Expected output:
# === VCluster Orchestrator V2 Pipeline ===
# Action: configure
# Processing resource: test in namespace: platform-requests
# ✓ Rendered: argocd-project-request.yaml
# ✓ Rendered: argocd-application-request.yaml
# ✓ Rendered: coredns-configmap.yaml
# ✓ Rendered: kubeconfig-sync-rbac.yaml
# ✓ Rendered: kubeconfig-sync-job.yaml
# ✓ Rendered: kubeconfig-external-secret.yaml
# ✓ Rendered: argocd-cluster-external-secret.yaml
# ✓ Status updated
# === Pipeline completed successfully ===
```

### 2. ResourceRequests Generated

```bash
# Check ArgoCD project ResourceRequest
kubectl get argocdprojects -n platform-requests vcluster-test
kubectl describe argocdprojects -n platform-requests vcluster-test

# Check ArgoCD application ResourceRequest
kubectl get argocdapplications -n platform-requests test
kubectl describe argocdapplications -n platform-requests test
```

### 3. Direct Resources in Target Namespace

```bash
# All resources should be in vcluster-test namespace
NS=vcluster-test

# 1. CoreDNS ConfigMap
kubectl get configmap -n $NS vc-test-coredns
kubectl get configmap -n $NS vc-test-coredns -o yaml | grep ".:1053"

# 2. ExternalSecret for OP token
kubectl get externalsecret -n $NS test-onepassword-token
kubectl get secret -n $NS test-onepassword-token  # Generated by ESO

# 3. RBAC for kubeconfig sync
kubectl get serviceaccount -n $NS test-kubeconfig-sync
kubectl get role -n $NS test-kubeconfig-sync
kubectl get rolebinding -n $NS test-kubeconfig-sync

# 4. Kubeconfig sync Job
kubectl get job -n $NS | grep kubeconfig-sync
kubectl logs -n $NS job/$(kubectl get job -n $NS -o name | grep kubeconfig-sync | head -1 | cut -d'/' -f2)

# Expected job log output:
# === VCluster Kubeconfig Sync to 1Password ===
# VCluster: test
# 1Password Item: vcluster-test-kubeconfig
# Vault: homelab
# Creating new 1Password item...
# ✓ Kubeconfig synced to 1Password successfully

# 5. Kubeconfig ExternalSecret
kubectl get externalsecret -n $NS test-kubeconfig
kubectl get secret -n $NS test-kubeconfig  # Should have 'config' key

# 6. ArgoCD cluster ExternalSecret (in argocd namespace)
kubectl get externalsecret -n argocd test-argocd-cluster
kubectl get secret -n argocd cluster-test-integratn-tech
kubectl get secret -n argocd cluster-test-integratn-tech -o yaml | grep "argocd.argoproj.io/secret-type: cluster"
```

### 4. VCluster Deployment

```bash
# Check ArgoCD application status
argocd app get vc-test

# Should show:
# Health Status: Healthy
# Sync Status: Synced

# Check vcluster pods
kubectl get pods -n vcluster-test

# Expected pods:
# test-0                          2/2     Running
# coredns-xxx                     1/1     Running

# Check vcluster service (LoadBalancer)
kubectl get svc -n vcluster-test test

# Should show:
# TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)
# LoadBalancer   10.x.x.x        10.0.4.100    443:xxxxx/TCP

# Verify VIP assigned
kubectl get svc -n vcluster-test test -o jsonpath='{.metadata.annotations.io\.cilium/lb-ipam-ips}'
# Should return: 10.0.4.100 (or auto-assigned from pool)
```

### 5. 1Password Integration

```bash
# Verify item exists in 1Password (requires op CLI)
op item get vcluster-test-kubeconfig --vault homelab

# Should show fields:
# - kubeconfig (concealed)
# - argocd-name: test.integratn-tech
# - argocd-server: https://test.integratn.tech:443
# - argocd-config (concealed)
```

### 6. ArgoCD Cluster Registration

```bash
# List ArgoCD clusters
argocd cluster list | grep test

# Should show:
# https://test.integratn.tech:443    test.integratn-tech    1.34    Successful

# Check cluster labels
kubectl get secret -n argocd cluster-test-integratn-tech -o jsonpath='{.metadata.labels}' | jq

# Should include:
# {
#   "integratn.tech/environment": "development",
#   "integratn.tech/cluster-type": "vcluster",
#   "integratn.tech/vcluster-name": "test"
# }
```

### 7. VCluster Connectivity

```bash
# Get kubeconfig from ExternalSecret
kubectl get secret -n vcluster-test test-kubeconfig -o jsonpath='{.data.config}' | base64 -d > /tmp/test-kubeconfig

# Test connectivity
kubectl --kubeconfig=/tmp/test-kubeconfig get namespaces

# Should show default vcluster namespaces:
# NAME              STATUS   AGE
# default           Active   5m
# kube-system       Active   5m
# kube-public       Active   5m
# kube-node-lease   Active   5m

# Deploy a test workload
kubectl --kubeconfig=/tmp/test-kubeconfig create deployment nginx --image=nginx
kubectl --kubeconfig=/tmp/test-kubeconfig get pods

# Cleanup
kubectl --kubeconfig=/tmp/test-kubeconfig delete deployment nginx
rm /tmp/test-kubeconfig
```

## Success Criteria

✅ All 8 resources generated successfully  
✅ Pipeline logs show no errors  
✅ VCluster pods running and healthy  
✅ LoadBalancer VIP assigned correctly  
✅ Kubeconfig synced to 1Password with correct fields  
✅ ArgoCD cluster registered with proper labels  
✅ kubectl connectivity to vcluster works  
✅ No `kind: Secret` resources created (all ExternalSecret)

## Troubleshooting

### Pipeline Fails

```bash
# Get pipeline pod name
PIPELINE_POD=$(kubectl get pods -n platform-requests -l kratix.io/promise-name=vcluster-orchestrator-v2 --sort-by=.metadata.creationTimestamp -o name | tail -1)

# View logs
kubectl logs -n platform-requests $PIPELINE_POD

# Check for common issues:
# - Go template errors (invalid YAML syntax)
# - Missing required spec fields
# - VIP calculation failures (invalid CIDR)
```

### Kubeconfig Sync Job Fails

```bash
# Check job status
kubectl describe job -n vcluster-test $(kubectl get job -n vcluster-test -o name | grep kubeconfig-sync)

# Common issues:
# - vc-test secret not created yet (initContainer waiting)
# - 1Password Connect API unreachable
# - Invalid OP token in ExternalSecret

# Check initContainer logs
kubectl logs -n vcluster-test $(kubectl get pod -n vcluster-test -l app.kubernetes.io/name=kubeconfig-sync -o name) -c wait-for-kubeconfig

# Check sync container logs
kubectl logs -n vcluster-test $(kubectl get pod -n vcluster-test -l app.kubernetes.io/name=kubeconfig-sync -o name) -c sync-to-onepassword
```

### ArgoCD Application Not Syncing

```bash
# Check application status
argocd app get vc-test

# Force sync
argocd app sync vc-test

# Check for common issues:
# - Project not created yet
# - Helm values invalid
# - Destination namespace doesn't exist
```

### VCluster Not Accessible

```bash
# Check LoadBalancer service
kubectl describe svc -n vcluster-test test

# Verify VIP in MetalLB range
# Expected: 10.0.4.100 (from subnet 10.0.4.0/24, offset 100)

# Check if VIP is reachable
ping -c 3 10.0.4.100

# Test HTTPS endpoint
curl -k https://10.0.4.100:443/version
# or
curl -k https://test.integratn.tech:443/version
```

## Comparison with V1

| Aspect | V1 (Bash) | V2 (Go SDK) |
|--------|-----------|-------------|
| Promise Executions | 8 | 3 |
| Pipeline Language | Bash + heredocs | Go + templates |
| Lines of Code | ~1500 (bash) | ~600 (Go) |
| Type Safety | None | Full |
| Error Handling | Exit codes | Structured errors |
| Template Validation | Runtime | Compile-time |
| Resource Generation | 7 ResourceRequests | 2 RR + 6 direct |
| Build Time | ~30s | ~35s |
| Container Size | ~50MB | ~30MB |

## Next Steps

Once validation passes:

1. **Monitor for 24-48 hours** - Ensure stability
2. **Test workload deployment** - Deploy sample apps to vcluster
3. **Validate ArgoCD ApplicationSets** - Test auto-deployment from workloads/ directory
4. **Document any issues** - Create GitHub issues for bugs
5. **Prepare for Phase 3** - Media vcluster migration planning

If any validation fails:
- Do NOT proceed to Phase 3
- Document failure modes
- Fix issues in v2 implementation
- Re-test with fresh test vcluster
