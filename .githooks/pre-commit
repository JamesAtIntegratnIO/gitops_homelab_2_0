#!/usr/bin/env bash
# Pre-commit hook to prevent committing forbidden Secret resources in promises-v2

set -e

RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

check_for_secrets() {
    local files_to_check=$(git diff --cached --name-only --diff-filter=ACM | grep '^promises-v2/' || true)
    
    if [[ -z "$files_to_check" ]]; then
        return 0
    fi

    local found_secrets=false
    
    while IFS= read -r file; do
        if [[ ! -f "$file" ]]; then
            continue
        fi
        
        # Check staged content for 'kind: Secret'
        if git show ":$file" | grep -q "kind: Secret"; then
            if [[ "$found_secrets" == "false" ]]; then
                echo -e "${RED}╔════════════════════════════════════════════════════════════════╗${NC}"
                echo -e "${RED}║  ERROR: Forbidden 'kind: Secret' found in promises-v2/        ║${NC}"
                echo -e "${RED}╚════════════════════════════════════════════════════════════════╝${NC}"
                echo ""
                echo -e "${YELLOW}This repository is PUBLIC. Secrets must NOT be committed.${NC}"
                echo ""
                echo "Files with forbidden 'kind: Secret':"
                found_secrets=true
            fi
            echo -e "  ${RED}✗${NC} $file"
        fi
    done <<< "$files_to_check"
    
    if [[ "$found_secrets" == "true" ]]; then
        echo ""
        echo -e "${YELLOW}Required Action:${NC}"
        echo "  Replace 'kind: Secret' with 'kind: ExternalSecret'"
        echo ""
        echo -e "${YELLOW}Example:${NC}"
        echo "  apiVersion: external-secrets.io/v1beta1"
        echo "  kind: ExternalSecret"
        echo "  metadata:"
        echo "    name: my-credentials"
        echo "  spec:"
        echo "    secretStoreRef:"
        echo "      name: onepassword-connect"
        echo "      kind: ClusterSecretStore"
        echo "    target:"
        echo "      name: my-credentials"
        echo "    data:"
        echo "      - secretKey: password"
        echo "        remoteRef:"
        echo "          key: vault-item-name"
        echo "          property: password"
        echo ""
        echo -e "${RED}Commit blocked.${NC}"
        return 1
    fi
    
    return 0
}

main() {
    if ! check_for_secrets; then
        exit 1
    fi
    
    # Additional checks can be added here
    
    exit 0
}

main "$@"
