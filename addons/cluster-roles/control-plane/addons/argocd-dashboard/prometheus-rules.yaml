apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: argocd-gitops-alerts
  namespace: monitoring
  labels:
    app.kubernetes.io/name: argocd-gitops-alerts
    app.kubernetes.io/part-of: argocd
    release: kube-prometheus-stack
spec:
  groups:
    - name: argocd.sync
      interval: 30s
      rules:
        - alert: ArgoCDAppOutOfSync
          expr: |
            min_over_time(argocd_app_info{sync_status="OutOfSync"}[30m]) == 1
          for: 5m
          labels:
            severity: warning
            component: argocd
          annotations:
            summary: "ArgoCD app {{ $labels.name }} out of sync for 30+ minutes"
            description: "Application {{ $labels.name }} in project {{ $labels.project }} has been OutOfSync for more than 30 minutes. Check ArgoCD UI for sync errors."
            logs_url: "https://grafana.cluster.integratn.tech/d/argocd-overview/argocd-overview"

        - alert: ArgoCDAppDegraded
          expr: |
            min_over_time(argocd_app_info{health_status="Degraded"}[5m]) == 1
          for: 5m
          labels:
            severity: warning
            component: argocd
          annotations:
            summary: "ArgoCD app {{ $labels.name }} degraded for 5+ minutes"
            description: "Application {{ $labels.name }} in project {{ $labels.project }} has been in Degraded health for more than 5 minutes. Resources may be crashing or unreachable."
            logs_url: "https://grafana.cluster.integratn.tech/d/argocd-overview/argocd-overview"

        - alert: ArgoCDHighSyncFailureRate
          expr: |
            (
              sum by (name) (increase(argocd_app_sync_total{phase!="Succeeded"}[1h]))
              /
              clamp_min(sum by (name) (increase(argocd_app_sync_total[1h])), 1)
            ) > 0.5
          for: 10m
          labels:
            severity: warning
            component: argocd
          annotations:
            summary: "ArgoCD app {{ $labels.name }} has >50% sync failure rate"
            description: "Application {{ $labels.name }} has failed more than half of its sync attempts in the last hour."
            logs_url: "https://grafana.cluster.integratn.tech/d/argocd-overview/argocd-overview"

    - name: etcd.fragmentation
      interval: 60s
      rules:
        - alert: EtcdHighFragmentation
          expr: |
            (etcd_mvcc_db_total_size_in_use_in_bytes / etcd_mvcc_db_total_size_in_bytes) < 0.5
            and etcd_mvcc_db_total_size_in_bytes > 100000000
          for: 30m
          labels:
            severity: warning
            component: etcd
          annotations:
            summary: "etcd database fragmentation ratio below 50%"
            description: "etcd DB has {{ $value | humanizePercentage }} in-use ratio (>50% wasted space). DB size: {{ with printf `etcd_mvcc_db_total_size_in_bytes{instance=\"%s\"}` $labels.instance }}{{ . | humanize1024 }}B{{ end }}. Consider running etcdctl defrag."
            logs_url: "https://grafana.cluster.integratn.tech/d/platform-landing-zone/platform-landing-zone"

        - alert: EtcdDBSizeApproachingQuota
          expr: |
            etcd_mvcc_db_total_size_in_bytes > 1.5 * 1024 * 1024 * 1024
          for: 5m
          labels:
            severity: critical
            component: etcd
          annotations:
            summary: "etcd database size exceeding 1.5GB (default quota: 2GB)"
            description: "etcd DB size is {{ $value | humanize1024 }}B, approaching the 2GB default quota. At quota, the cluster goes read-only. Investigate excessive resource creation or run etcdctl defrag."
            logs_url: "https://grafana.cluster.integratn.tech/d/platform-landing-zone/platform-landing-zone"

    - name: capacity.headroom
      interval: 60s
      rules:
        - alert: ClusterCPUHighUtilization
          expr: |
            (sum(rate(container_cpu_usage_seconds_total{container!=""}[5m])) / sum(kube_node_status_allocatable{resource="cpu"})) > 0.85
          for: 15m
          labels:
            severity: warning
            component: cluster
          annotations:
            summary: "Cluster CPU utilization above 85%"
            description: "Cluster is using {{ $value | humanizePercentage }} of allocatable CPU. Consider adding nodes or reducing workload."
            logs_url: "https://grafana.cluster.integratn.tech/d/platform-landing-zone/platform-landing-zone"

        - alert: ClusterMemoryHighUtilization
          expr: |
            (sum(container_memory_working_set_bytes{container!=""}) / sum(kube_node_status_allocatable{resource="memory"})) > 0.85
          for: 15m
          labels:
            severity: warning
            component: cluster
          annotations:
            summary: "Cluster memory utilization above 85%"
            description: "Cluster is using {{ $value | humanizePercentage }} of allocatable memory. Memory pressure leads to OOM kills."
            logs_url: "https://grafana.cluster.integratn.tech/d/platform-landing-zone/platform-landing-zone"
