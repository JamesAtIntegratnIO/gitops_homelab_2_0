globalSelectors:
  cluster_name: media

sonarr:
  enabled: true
  namespace: media
  chartRepository: https://stakater.github.io/stakater-charts
  chartName: application
  defaultVersion: 6.14.0
  ignoreDifferences:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      jqPathExpressions:
        - .status
      jsonPointers:
        - /spec/rules/0/backendRefs/0/group
        - /spec/rules/0/backendRefs/0/kind
        - /spec/rules/0/backendRefs/0/weight
        - /spec/parentRefs/0/group
        - /spec/parentRefs/0/kind
  valuesObject:
    applicationName: sonarr
    extraObjects:
      - apiVersion: external-secrets.io/v1beta1
        kind: ExternalSecret
        metadata:
          name: eso-homepage-secret
          namespace: media
        spec:
          refreshInterval: 1h
          secretStoreRef:
            kind: ClusterSecretStore
            name: onepassword-store
          target:
            name: homepage-secret
            creationPolicy: Owner
          dataFrom:
            - extract:
                key: homepage-secret
                decodingStrategy: None
                conversionStrategy: Default
                metadataPolicy: None
      - apiVersion: v1
        kind: PersistentVolume
        metadata:
          name: sonarr-config-pv
          labels:
            app: sonarr
          annotations:
            pv.kubernetes.io/provisioned-by: k8s-sigs.io/nfs-subdir-external-provisioner
        spec:
          accessModes:
            - ReadWriteOnce
          capacity:
            storage: 1Gi
          nfs:
            path: /mnt/user/kube_storage/sonarr-config-pvc
            server: 10.0.0.12
          persistentVolumeReclaimPolicy: Retain
          storageClassName: config-nfs-client
          volumeMode: Filesystem
      - apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: sonarr-config-pvc
          namespace: media
          labels:
            app: sonarr
        spec:
          storageClassName: config-nfs-client
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 1Gi
          volumeName: sonarr-config-pv
      - apiVersion: v1
        kind: PersistentVolume
        metadata:
          name: sonarr-media-pv
          labels:
            app: sonarr
          annotations:
            pv.kubernetes.io/provisioned-by: k8s-sigs.io/data-nfs-subdir-external-provisioner
        spec:
          accessModes:
            - ReadWriteOnce
          capacity:
            storage: 1Gi
          nfs:
            path: /mnt/user/data
            server: 10.0.0.12
          persistentVolumeReclaimPolicy: Retain
          storageClassName: data-nfs-client
          volumeMode: Filesystem
      - apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: sonarr-media-pvc
          namespace: media
          labels:
            app: sonarr
        spec:
          storageClassName: data-nfs-client
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 1Gi
          volumeName: sonarr-media-pv
    deployment:
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containerSecurityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        readOnlyRootFilesystem: false
      image:
        repository: linuxserver/sonarr
        tag: latest
        pullPolicy: IfNotPresent
      ports:
        - name: http
          containerPort: 8989
          protocol: TCP
      env:
        TZ:
          value: America/Denver
        PUID:
          value: "1000"
        PGID:
          value: "1000"
        PUSHOVER_DEBUG:
          value: "false"
        SONARR__AUTHENTICATION_METHOD:
          value: External
        SONARR__AUTHENTICATION_REQUIRED:
          value: DisabledForLocalAddresses
        SONARR__INSTANCE_NAME:
          value: Sonarr
        SONARR__PORT:
          value: "8989"
        SONARR__LOG_LEVEL:
          value: info
        SONARR__THEME:
          value: dark
      additionalContainers:
        - name: exportarr
          image: ghcr.io/onedr0p/exportarr:latest
          command:
            - /exportarr
          args:
            - sonarr
          ports:
            - name: metrics
              containerPort: 9707
              protocol: TCP
          env:
            - name: PORT
              value: "9707"
            - name: URL
              value: http://localhost:8989
            - name: APIKEY
              valueFrom:
                secretKeyRef:
                  name: homepage-secret
                  key: HOMEPAGE_VAR_SONARR_KEY
      volumes:
        config:
          persistentVolumeClaim:
            claimName: sonarr-config-pvc
        media:
          persistentVolumeClaim:
            claimName: sonarr-media-pvc
      volumeMounts:
        config:
          mountPath: /config
        media:
          mountPath: /data
    persistence:
      enabled: false
    service:
      additionalLabels:
        prometheus: media-cluster
      ports:
        - name: http
          port: 8989
          targetPort: 8989
          protocol: TCP
    serviceMonitor:
      enabled: false
    httpRoute:
      enabled: true
      parentRefs:
        - name: nginx-gateway
          namespace: nginx-gateway
          sectionName: https
      hostnames:
        - sonarr.media.integratn.tech
      rules:
        - backendRefs:
            - name: sonarr
              port: 8989
          matches:
            - path:
                type: PathPrefix
                value: /
    certificate:
      enabled: true
      secretName: sonarr-tls
      dnsNames:
        - sonarr.media.integratn.tech
      commonName: sonarr.media.integratn.tech
      subject: {}
      usages:
        - digital signature
        - key encipherment
        - server auth
      issuerRef:
        name: letsencrypt-prod
        kind: ClusterIssuer
