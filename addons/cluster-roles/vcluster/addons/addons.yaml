argocd-vcluster:
  enabled: true
  chartName: argo-cd
  namespace: argocd
  releaseName: argo-cd
  project: platform
  defaultVersion: "9.0.3"
  chartRepository: "https://argoproj.github.io/argo-helm"
  selector:
    matchExpressions:
      - key: enable_argocd
        operator: In
        values: ['true']
      - key: cluster_role
        operator: In
        values: ['vcluster']
  ignoreDifferences:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      jqPathExpressions:
        - .status
      jsonPointers:
        - /spec/rules/0/backendRefs/0/group
        - /spec/rules/0/backendRefs/0/kind
        - /spec/rules/0/backendRefs/0/weight
        - /spec/parentRefs/0/group
        - /spec/parentRefs/0/kind
  valuesObject:
    global:
      domain: '{{ printf "argocd.%s.%s" .metadata.labels.cluster_name (index .metadata.annotations "platform.integratn.tech/base-domain") }}'
    configs:
      params:
        server.insecure: true
        server.url: 'https://{{ printf "argocd.%s.%s" .metadata.labels.cluster_name (index .metadata.annotations "platform.integratn.tech/base-domain") }}'
    extraObjects:
      - apiVersion: gateway.networking.k8s.io/v1
        kind: HTTPRoute
        metadata:
          name: argocd
          namespace: argocd
        spec:
          parentRefs:
            - name: nginx-gateway
              namespace: nginx-gateway
              sectionName: https
          hostnames:
            - '{{ printf "argocd.%s.%s" .metadata.labels.cluster_name (index .metadata.annotations "platform.integratn.tech/base-domain") }}'
          rules:
            - matches:
                - path:
                    type: PathPrefix
                    value: /
              backendRefs:
                - name: argo-cd-argocd-server
                  port: 80
      - apiVersion: gateway.networking.k8s.io/v1
        kind: HTTPRoute
        metadata:
          name: argocd-http-redirect
          namespace: argocd
        spec:
          parentRefs:
            - name: nginx-gateway
              namespace: nginx-gateway
              sectionName: http
          hostnames:
            - '{{ printf "argocd.%s.%s" .metadata.labels.cluster_name (index .metadata.annotations "platform.integratn.tech/base-domain") }}'
          rules:
            - filters:
                - type: RequestRedirect
                  requestRedirect:
                    scheme: https
                    statusCode: 301
              matches:
                - path:
                    type: PathPrefix
                    value: /
      - apiVersion: argoproj.io/v1alpha1
        kind: ApplicationSet
        metadata:
          name: workloads
          namespace: argocd
        spec:
          goTemplate: true
          syncPolicy:
            preserveResourcesOnDeletion: false
          generators:
            - list:
                elements:
                  - name: in-cluster
                    server: https://kubernetes.default.svc
                    metadata:
                      labels:
                        environment: '{{ .metadata.labels.environment }}'
                        cluster_name: '{{ .metadata.labels.cluster_name }}'
                      annotations:
                        workload_repo_url: '{{ index .metadata.annotations "workload_repo_url" }}'
                        workload_repo_basepath: '{{ index .metadata.annotations "workload_repo_basepath" }}'
                        workload_repo_path: '{{ index .metadata.annotations "workload_repo_path" }}'
                        workload_repo_revision: '{{ index .metadata.annotations "workload_repo_revision" }}'
          template:
            metadata:
              name: 'workload-{{ .metadata.labels.environment }}'
            spec:
              project: default
              sources:
                - repoURL: '{{ .metadata.annotations.workload_repo_url }}'
                  targetRevision: '{{ .metadata.annotations.workload_repo_revision }}'
                  ref: values
                - repoURL: '{{ .metadata.annotations.workload_repo_url }}'
                  path: addons/charts/application-sets
                  targetRevision: '{{ .metadata.annotations.workload_repo_revision }}'
                  helm:
                    ignoreMissingValueFiles: true
                    valuesObject:
                      repoURLGit: '{{ .metadata.annotations.workload_repo_url }}'
                      repoURLGitRevision: '{{ .metadata.annotations.workload_repo_revision }}'
                      repoURLGitBasePath: '{{ .metadata.annotations.workload_repo_basepath }}'
                      useValuesFilePrefix: false
                      valueFiles: []
                    valueFiles:
                      - '$values/{{ .metadata.annotations.workload_repo_basepath }}{{ .metadata.annotations.workload_repo_path }}/{{ .metadata.labels.cluster_name }}/addons.yaml'
              destination:
                namespace: workload
                name: in-cluster
              syncPolicy:
                automated: {}
                syncOptions:
                  - CreateNamespace=true

external-dns-vcluster:
  enabled: true
  releaseName: external-dns
  namespace: '{{.metadata.annotations.external_dns_namespace}}'
  chartName: external-dns
  project: platform-services
  chartRepository: https://kubernetes-sigs.github.io/external-dns
  defaultVersion: "1.19.0"
  selector:
    matchExpressions:
      - key: enable_external_dns
        operator: In
        values: ['true']
      - key: cluster_role
        operator: In
        values: ['vcluster']
  valuesObject:
    logLevel: info
    domainFilters:
      - '{{ index .metadata.annotations "platform.integratn.tech/base-domain" }}'
    txtOwnerId: '{{ .metadata.labels.cluster_name }}'
    txtPrefix: '{{ printf "%s-" .metadata.labels.cluster_name }}'
    extraArgs:
      - --gateway-name=nginx-gateway

external-dns-resources-vcluster:
  enabled: true
  type: manifest
  namespace: external-dns
  project: platform-services
  path: addons/cluster-roles/vcluster/addons/external-dns-resources
  selector:
    matchExpressions:
      - key: enable_external_dns
        operator: In
        values: ['true']
      - key: cluster_role
        operator: In
        values: ['vcluster']

cert-manager-vcluster:
  enabled: true
  releaseName: cert-manager
  namespace: '{{.metadata.annotations.cert_manager_namespace}}'
  chartName: cert-manager
  project: platform-services
  chartRepository: https://charts.jetstack.io
  defaultVersion: "v1.16.2"
  annotationsApp:
    argocd.argoproj.io/sync-wave: "-1"
  selector:
    matchExpressions:
      - key: enable_cert_manager
        operator: In
        values: ['true']
      - key: cluster_role
        operator: In
        values: ['vcluster']
  valuesObject:
    crds:
      enabled: true
    clusterResourceNamespace: '{{.metadata.annotations.cert_manager_namespace}}'
    global:
      leaderElection:
        namespace: '{{.metadata.annotations.cert_manager_namespace}}'
    extraObjects:
      - |
        apiVersion: external-secrets.io/v1beta1
        kind: ExternalSecret
        metadata:
          name: cloudflare-api-key
          namespace: cert-manager
        spec:
          refreshInterval: 1h
          secretStoreRef:
            kind: ClusterSecretStore
            name: onepassword-store
          target:
            name: cloudflare-api-key
            creationPolicy: Owner
          data:
            - secretKey: CF_API_KEY
              remoteRef:
                key: cloudflare-api-key
                property: CF_API_KEY
                conversionStrategy: Default
                decodingStrategy: None
                metadataPolicy: None
            - secretKey: CF_API_EMAIL
              remoteRef:
                key: cloudflare-api-key
                property: CF_API_EMAIL
                conversionStrategy: Default
                decodingStrategy: None
                metadataPolicy: None
      - |
        apiVersion: cert-manager.io/v1
        kind: ClusterIssuer
        metadata:
          name: letsencrypt-prod
          labels:
            integratn.tech/cluster-issuer: letsencrypt-prod
        spec:
          acme:
            server: https://acme-v02.api.letsencrypt.org/directory
            email: james@integratn.io
            privateKeySecretRef:
              name: letsencrypt-prod
            solvers:
              - selector:
                  dnsZones:
                    - {{ index .metadata.annotations "platform.integratn.tech/base-domain" }}
                dns01:
                  cloudflare:
                    email: james@integratn.io
                    apiKeySecretRef:
                      name: cloudflare-api-key
                      key: CF_API_KEY
      - |
        apiVersion: cert-manager.io/v1
        kind: Certificate
        metadata:
          name: wildcard-{{ .metadata.labels.cluster_name }}-{{ index .metadata.annotations "platform.integratn.tech/base-domain-sanitized" }}
          namespace: nginx-gateway
        spec:
          secretName: wildcard-{{ .metadata.labels.cluster_name }}-{{ index .metadata.annotations "platform.integratn.tech/base-domain-sanitized" }}-tls
          issuerRef:
            name: letsencrypt-prod
            kind: ClusterIssuer
          dnsNames:
            - '*.{{ .metadata.labels.cluster_name }}.{{ index .metadata.annotations "platform.integratn.tech/base-domain" }}'
      - |
        apiVersion: gateway.networking.k8s.io/v1beta1
        kind: ReferenceGrant
        metadata:
          name: allow-httproutes-from-all
          namespace: nginx-gateway
          annotations:
            argocd.argoproj.io/compare-options: IgnoreExtraneous
            argocd.argoproj.io/sync-options: Prune=false
        spec:
          from:
            - group: gateway.networking.k8s.io
              kind: HTTPRoute
              namespace: argocd
          to:
            - group: ""
              kind: Service
            - group: gateway.networking.k8s.io
              kind: Gateway
  syncPolicy:
    automated: {}
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      - SkipDryRunOnMissingResource=true

nginx-gateway-fabric-vcluster:
  enabled: true
  namespace: nginx-gateway
  releaseName: nginx-gateway-fabric
  chartName: nginx-gateway-fabric
  project: platform-services
  chartRepository: oci://ghcr.io/nginx/charts/nginx-gateway-fabric
  defaultVersion: "2.2.2"
  helmSkipCrds: true
  annotationsApp:
    argocd.argoproj.io/sync-wave: "10"
  selector:
    matchExpressions:
      - key: enable_nginx_gateway_fabric
        operator: In
        values: ['true']
      - key: cluster_role
        operator: In
        values: ['vcluster']
  ignoreDifferences:
    - group: gateway.networking.k8s.io
      kind: Gateway
      jqPathExpressions:
        - .status
  valuesObject:
    gateways:
      - name: nginx-gateway
        namespace: nginx-gateway
        labels:
          app: nginx-gateway-fabric
        annotations:
          cert-manager.io/cluster-issuer: letsencrypt-prod
          argocd.argoproj.io/compare-options: IgnoreExtraneous
          argocd.argoproj.io/sync-options: Prune=false
        spec:
          gatewayClassName: nginx
          listeners:
            - name: http
              port: 80
              protocol: HTTP
              hostname: '{{ printf "*.%s.%s" .metadata.labels.cluster_name (index .metadata.annotations "platform.integratn.tech/base-domain") }}'
              allowedRoutes:
                namespaces:
                  from: All
            - name: https
              port: 443
              protocol: HTTPS
              hostname: '{{ printf "*.%s.%s" .metadata.labels.cluster_name (index .metadata.annotations "platform.integratn.tech/base-domain") }}'
              tls:
                mode: Terminate
                certificateRefs:
                  - group: ""
                    kind: Secret
                    name: 'wildcard-{{ .metadata.labels.cluster_name }}-{{ index .metadata.annotations "platform.integratn.tech/base-domain-sanitized" }}-tls'
              allowedRoutes:
                namespaces:
                  from: All
  syncPolicy:
    automated: {}
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      - Replace=true