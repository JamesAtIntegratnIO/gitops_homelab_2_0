# Kratix Values for control-plane clusters

# Disable default BucketStateStore
stateStores: []

# Disable default destinations
destinations: []

# Additional resources for Kratix platform setup
additionalResources:
  
  # ExternalSecret to pull GitHub App credentials from 1Password
  - apiVersion: external-secrets.io/v1beta1
    kind: ExternalSecret
    metadata:
      name: kratix-github-credentials
      namespace: kratix-platform-system
    spec:
      secretStoreRef:
        name: onepassword-store
        kind: ClusterSecretStore
      target:
        name: kratix-github-credentials
        creationPolicy: Owner
      data:
        - secretKey: appID
          remoteRef:
            key: kratix-gitops-statestore
            property: AppID
        - secretKey: installationID
          remoteRef:
            key: kratix-gitops-statestore
            property: InstallID
        - secretKey: privateKey
          remoteRef:
            key: kratix-gitops-statestore
            property: PrivateKey
  
  # GitStateStore pointing to kratix-platform-state repository
  - apiVersion: platform.kratix.io/v1alpha1
    kind: GitStateStore
    metadata:
      name: default
      namespace: kratix-platform-system
    spec:
      authMethod: githubApp
      secretRef:
        name: kratix-github-credentials
        namespace: kratix-platform-system
      url: https://github.com/jamesatintegratnio/kratix-platform-state
      branch: main
      path: clusters

  # PVC for Kratix Git workspace
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: kratix-git-storage
      namespace: kratix-platform-system
    spec:
      accessModes:
        - ReadWriteMany
      resources:
        requests:
          storage: 1Gi
  
  # Destination for the-cluster workload scheduling
  - apiVersion: platform.kratix.io/v1alpha1
    kind: Destination
    metadata:
      name: the-cluster
      namespace: kratix-platform-system
      labels:
        environment: production
        cluster-role: control-plane
        capability.vcluster: "true"
    spec:
      stateStoreRef:
        name: default
        kind: GitStateStore
      path: the-cluster
      strictMatchLabels: false
  
  # ArgoCD Application to reconcile state from kratix-platform-state repo
  - apiVersion: argoproj.io/v1alpha1
    kind: Application
    metadata:
      name: kratix-state-reconciler
      namespace: argocd
      finalizers:
        - resources-finalizer.argocd.argoproj.io
    spec:
      project: platform
      source:
        repoURL: https://github.com/jamesatintegratnio/kratix-platform-state
        targetRevision: main
        path: clusters/the-cluster
        directory:
          recurse: true
      destination:
        server: https://kubernetes.default.svc
        namespace: kratix-platform-system
      syncPolicy:
        automated:
          selfHeal: true
          prune: true
        syncOptions:
          - CreateNamespace=true
      ignoreDifferences:
        - group: networking.k8s.io
          kind: NetworkPolicy
          name: default-deny-all
          jsonPointers:
            - /metadata/labels
            - /metadata/annotations
        - group: batch
          kind: Job
          jsonPointers:
            - /spec
            - /status
        - group: argoproj.io
          kind: Application
          namespace: argocd
          jsonPointers:
            - /metadata/annotations/argocd.argoproj.io~1tracking-id
            - /metadata/annotations/kubectl.kubernetes.io~1last-applied-configuration
        - group: argoproj.io
          kind: AppProject
          namespace: argocd
          jsonPointers:
            - /metadata/annotations/argocd.argoproj.io~1tracking-id
            - /metadata/annotations/kubectl.kubernetes.io~1last-applied-configuration
            - /metadata/labels
        - group: platform.integratn.tech
          kind: ArgoCDApplication
          namespace: platform-requests
          jsonPointers:
            - /metadata/annotations/argocd.argoproj.io~1tracking-id
            - /metadata/annotations/kubectl.kubernetes.io~1last-applied-configuration
            - /metadata/labels
        - group: platform.integratn.tech
          kind: ArgoCDProject
          namespace: platform-requests
          jsonPointers:
            - /metadata/annotations/argocd.argoproj.io~1tracking-id
            - /metadata/annotations/kubectl.kubernetes.io~1last-applied-configuration
            - /metadata/labels
        - group: platform.integratn.tech
          kind: ArgoCDClusterRegistration
          namespace: platform-requests
          jsonPointers:
            - /metadata/annotations/argocd.argoproj.io~1tracking-id
            - /metadata/annotations/kubectl.kubernetes.io~1last-applied-configuration
            - /metadata/labels

  # --- Pipeline Cleanup ---

  # ServiceAccount for pipeline cleanup CronJob
  - apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: kratix-pipeline-cleanup
      namespace: platform-requests
      labels:
        app.kubernetes.io/part-of: kratix

  # Role to delete completed Jobs in platform-requests
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: Role
    metadata:
      name: kratix-pipeline-cleanup
      namespace: platform-requests
      labels:
        app.kubernetes.io/part-of: kratix
    rules:
      - apiGroups: ["batch"]
        resources: ["jobs"]
        verbs: ["list", "delete"]

  # Bind the Role to the ServiceAccount
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: RoleBinding
    metadata:
      name: kratix-pipeline-cleanup
      namespace: platform-requests
      labels:
        app.kubernetes.io/part-of: kratix
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: Role
      name: kratix-pipeline-cleanup
    subjects:
      - kind: ServiceAccount
        name: kratix-pipeline-cleanup
        namespace: platform-requests

  # CronJob to delete succeeded pipeline Jobs older than 24h (keeps failed Jobs)
  - apiVersion: batch/v1
    kind: CronJob
    metadata:
      name: kratix-pipeline-cleanup
      namespace: platform-requests
      labels:
        app.kubernetes.io/part-of: kratix
    spec:
      schedule: "0 4 * * *"
      successfulJobsHistoryLimit: 1
      failedJobsHistoryLimit: 3
      jobTemplate:
        spec:
          ttlSecondsAfterFinished: 3600
          template:
            spec:
              serviceAccountName: kratix-pipeline-cleanup
              restartPolicy: OnFailure
              securityContext:
                runAsNonRoot: true
                seccompProfile:
                  type: RuntimeDefault
              containers:
                - name: cleanup
                  image: bitnami/kubectl:latest
                  securityContext:
                    allowPrivilegeEscalation: false
                    capabilities:
                      drop: ["ALL"]
                    readOnlyRootFilesystem: true
                  command:
                    - /bin/sh
                    - -c
                    - |
                      echo "Cleaning up succeeded pipeline Jobs older than 24h..."
                      kubectl get jobs -n platform-requests -o json | \
                        jq -r '.items[] |
                          select(.status.succeeded == 1) |
                          select(.status.completionTime != null) |
                          select((now - (.status.completionTime | fromdateiso8601)) > 86400) |
                          .metadata.name' | \
                        while read -r job; do
                          echo "Deleting completed job: $job"
                          kubectl delete job -n platform-requests "$job" --cascade=foreground
                        done
                      echo "Cleanup complete."

  # --- Kratix Observability ---

  # ServiceAccount for Prometheus to authenticate to the metrics endpoint
  - apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: kratix-metrics-reader
      namespace: kratix-platform-system
      labels:
        app.kubernetes.io/part-of: kratix

  # Secret to generate a long-lived token for the ServiceAccount
  - apiVersion: v1
    kind: Secret
    metadata:
      name: kratix-metrics-reader-token
      namespace: kratix-platform-system
      annotations:
        kubernetes.io/service-account.name: kratix-metrics-reader
    type: kubernetes.io/service-account-token

  # ClusterRole granting access to metrics endpoint via kube-rbac-proxy
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: kratix-metrics-reader
    rules:
      - nonResourceURLs: ["/metrics"]
        verbs: ["get"]

  # Bind the ServiceAccount to the ClusterRole
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: kratix-metrics-reader
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: kratix-metrics-reader
    subjects:
      - kind: ServiceAccount
        name: kratix-metrics-reader
        namespace: kratix-platform-system

  # ServiceMonitor for Kratix controller manager metrics
  - apiVersion: monitoring.coreos.com/v1
    kind: ServiceMonitor
    metadata:
      name: kratix-controller-manager
      namespace: kratix-platform-system
      labels:
        app.kubernetes.io/part-of: kratix
    spec:
      selector:
        matchLabels:
          control-plane: controller-manager
      namespaceSelector:
        matchNames:
          - kratix-platform-system
      endpoints:
        - port: https
          scheme: https
          tlsConfig:
            insecureSkipVerify: true
          bearerTokenSecret:
            name: kratix-metrics-reader-token
            key: token
          interval: 30s
          metricRelabelings:
            - action: keep
              sourceLabels: [__name__]
              regex: kratix_.*|workqueue_.*|controller_runtime_.*|process_.*|go_.*

  # PrometheusRule for Kratix platform alerts
  - apiVersion: monitoring.coreos.com/v1
    kind: PrometheusRule
    metadata:
      name: kratix-platform-alerts
      namespace: kratix-platform-system
      labels:
        app.kubernetes.io/part-of: kratix
    spec:
      groups:
        - name: kratix.pipeline
          interval: 30s
          rules:
            - alert: KratixPipelineFailed
              expr: |
                kube_pod_status_phase{namespace="platform-requests", phase="Failed"} > 0
              for: 5m
              labels:
                severity: warning
                component: kratix
              annotations:
                summary: "Kratix pipeline pod failed"
                description: 'Pipeline pod {{ "{{" }} $labels.pod {{ "}}" }} in namespace {{ "{{" }} $labels.namespace {{ "}}" }} has been in Failed state for more than 5 minutes.'
                logs_url: 'https://grafana.cluster.integratn.tech/explore?orgId=1&left=%7B%22datasource%22%3A%22loki%22%2C%22queries%22%3A%5B%7B%22refId%22%3A%22A%22%2C%22expr%22%3A%22%7Bnamespace%3D%5C%22platform-requests%5C%22%2C%20pod%3D%5C%22{{ "{{" }} $labels.pod {{ "}}" }}%5C%22%7D%22%7D%5D%2C%22range%22%3A%7B%22from%22%3A%22now-1h%22%2C%22to%22%3A%22now%22%7D%7D'
            - alert: KratixPipelineStuck
              expr: |
                (kube_pod_status_phase{namespace="platform-requests", phase=~"Pending|Running"} == 1)
                * on(pod, namespace) group_left()
                (time() - kube_pod_start_time{namespace="platform-requests"} > 900)
              for: 5m
              labels:
                severity: warning
                component: kratix
              annotations:
                summary: "Kratix pipeline pod stuck"
                description: 'Pipeline pod {{ "{{" }} $labels.pod {{ "}}" }} has been running for more than 15 minutes.'
                logs_url: 'https://grafana.cluster.integratn.tech/explore?orgId=1&left=%7B%22datasource%22%3A%22loki%22%2C%22queries%22%3A%5B%7B%22refId%22%3A%22A%22%2C%22expr%22%3A%22%7Bnamespace%3D%5C%22platform-requests%5C%22%2C%20pod%3D%5C%22{{ "{{" }} $labels.pod {{ "}}" }}%5C%22%7D%22%7D%5D%2C%22range%22%3A%7B%22from%22%3A%22now-1h%22%2C%22to%22%3A%22now%22%7D%7D'
        - name: kratix.reconciliation
          interval: 30s
          rules:
            - alert: KratixReconcileErrors
              expr: |
                sum by (controller) (increase(controller_runtime_reconcile_errors_total{job=~".*kratix.*"}[10m])) > 0
              for: 5m
              labels:
                severity: critical
                component: kratix
              annotations:
                summary: "Kratix controller reconcile errors"
                description: 'Controller {{ "{{" }} $labels.controller {{ "}}" }} has had reconcile errors in the last 10 minutes.'
                logs_url: 'https://grafana.cluster.integratn.tech/explore?orgId=1&left=%7B%22datasource%22%3A%22loki%22%2C%22queries%22%3A%5B%7B%22refId%22%3A%22A%22%2C%22expr%22%3A%22%7Bnamespace%3D%5C%22kratix-platform-system%5C%22%7D%20%7C~%20%5C%22%28%3Fi%29%28error%7Creconcil%7Cfail%29%5C%22%22%20%20%7D%5D%2C%22range%22%3A%7B%22from%22%3A%22now-1h%22%2C%22to%22%3A%22now%22%7D%7D'
            - alert: KratixWorkQueueStuck
              expr: |
                workqueue_unfinished_work_seconds{job=~".*kratix.*"} > 300
              for: 5m
              labels:
                severity: critical
                component: kratix
              annotations:
                summary: "Kratix work queue stuck"
                description: 'Work queue {{ "{{" }} $labels.name {{ "}}" }} has had unfinished work for more than 5 minutes.'
                logs_url: 'https://grafana.cluster.integratn.tech/explore?orgId=1&left=%7B%22datasource%22%3A%22loki%22%2C%22queries%22%3A%5B%7B%22refId%22%3A%22A%22%2C%22expr%22%3A%22%7Bnamespace%3D%5C%22kratix-platform-system%5C%22%7D%20%7C~%20%5C%22%28%3Fi%29%28queue%7Cstuck%7Ctimeout%7Cslow%29%5C%22%22%20%20%7D%5D%2C%22range%22%3A%7B%22from%22%3A%22now-1h%22%2C%22to%22%3A%22now%22%7D%7D'
            - alert: KratixReconcileStuck
              expr: |
                workqueue_longest_running_processor_seconds{job=~".*kratix.*"} > 300
              for: 5m
              labels:
                severity: warning
                component: kratix
              annotations:
                summary: "Kratix reconciliation stuck"
                description: 'Queue {{ "{{" }} $labels.name {{ "}}" }} has a processor running for {{ "{{" }} $value | humanizeDuration {{ "}}" }}. A reconciliation may be hung waiting on an external resource.'
                logs_url: 'https://grafana.cluster.integratn.tech/explore?orgId=1&left=%7B%22datasource%22%3A%22loki%22%2C%22queries%22%3A%5B%7B%22refId%22%3A%22A%22%2C%22expr%22%3A%22%7Bnamespace%3D%5C%22kratix-platform-system%5C%22%7D%20%7C~%20%5C%22%28%3Fi%29%28reconcil%7Cstuck%7Ctimeout%7Cslow%29%5C%22%22%20%20%7D%5D%2C%22range%22%3A%7B%22from%22%3A%22now-1h%22%2C%22to%22%3A%22now%22%7D%7D'
            - alert: KratixHighCPU
              expr: |
                rate(process_cpu_seconds_total{job=~".*kratix.*"}[5m]) > 0.5
              for: 15m
              labels:
                severity: warning
                component: kratix
              annotations:
                summary: "Kratix controller high CPU usage"
                description: 'Kratix controller is using {{ "{{" }} $value | humanize {{ "}}" }} CPU cores for more than 15 minutes. May indicate a reconciliation storm.'
                logs_url: 'https://grafana.cluster.integratn.tech/explore?orgId=1&left=%7B%22datasource%22%3A%22loki%22%2C%22queries%22%3A%5B%7B%22refId%22%3A%22A%22%2C%22expr%22%3A%22%7Bnamespace%3D%5C%22kratix-platform-system%5C%22%7D%22%20%20%7D%5D%2C%22range%22%3A%7B%22from%22%3A%22now-1h%22%2C%22to%22%3A%22now%22%7D%7D'
            - alert: KratixHighMemory
              expr: |
                process_resident_memory_bytes{job=~".*kratix.*"} > 512 * 1024 * 1024
              for: 15m
              labels:
                severity: warning
                component: kratix
              annotations:
                summary: "Kratix controller high memory usage"
                description: 'Kratix controller RSS is {{ "{{" }} $value | humanize1024 {{ "}}" }}B. May indicate a memory leak or excessive caching.'
                logs_url: 'https://grafana.cluster.integratn.tech/explore?orgId=1&left=%7B%22datasource%22%3A%22loki%22%2C%22queries%22%3A%5B%7B%22refId%22%3A%22A%22%2C%22expr%22%3A%22%7Bnamespace%3D%5C%22kratix-platform-system%5C%22%7D%22%20%20%7D%5D%2C%22range%22%3A%7B%22from%22%3A%22now-1h%22%2C%22to%22%3A%22now%22%7D%7D'
            - alert: KratixGoroutineLeak
              expr: |
                go_goroutines{job=~".*kratix.*"} > 500
              for: 30m
              labels:
                severity: warning
                component: kratix
              annotations:
                summary: "Kratix controller goroutine leak suspected"
                description: 'Kratix controller has {{ "{{" }} $value {{ "}}" }} goroutines. A steadily increasing count indicates a goroutine leak.'
                logs_url: 'https://grafana.cluster.integratn.tech/explore?orgId=1&left=%7B%22datasource%22%3A%22loki%22%2C%22queries%22%3A%5B%7B%22refId%22%3A%22A%22%2C%22expr%22%3A%22%7Bnamespace%3D%5C%22kratix-platform-system%5C%22%7D%22%20%20%7D%5D%2C%22range%22%3A%7B%22from%22%3A%22now-1h%22%2C%22to%22%3A%22now%22%7D%7D'
        - name: kratix.statestore
          interval: 60s
          rules:
            - alert: KratixStateReconcilerOutOfSync
              expr: |
                argocd_app_info{name="kratix-state-reconciler", sync_status!="Synced"} == 1
              for: 10m
              labels:
                severity: warning
                component: kratix
              annotations:
                summary: "Kratix state reconciler out of sync"
                description: "The kratix-state-reconciler ArgoCD application has been out of sync for more than 10 minutes."
                logs_url: 'https://grafana.cluster.integratn.tech/explore?orgId=1&left=%7B%22datasource%22%3A%22loki%22%2C%22queries%22%3A%5B%7B%22refId%22%3A%22A%22%2C%22expr%22%3A%22%7Bnamespace%3D%5C%22argocd%5C%22%7D%20%7C~%20%5C%22kratix-state-reconciler%5C%22%22%20%20%7D%5D%2C%22range%22%3A%7B%22from%22%3A%22now-1h%22%2C%22to%22%3A%22now%22%7D%7D'
            - alert: KratixStateReconcilerDegraded
              expr: |
                argocd_app_info{name="kratix-state-reconciler", health_status!="Healthy"} == 1
              for: 5m
              labels:
                severity: critical
                component: kratix
              annotations:
                summary: "Kratix state reconciler unhealthy"
                description: 'The kratix-state-reconciler ArgoCD application health is {{ "{{" }} $labels.health_status {{ "}}" }}.'
                logs_url: 'https://grafana.cluster.integratn.tech/explore?orgId=1&left=%7B%22datasource%22%3A%22loki%22%2C%22queries%22%3A%5B%7B%22refId%22%3A%22A%22%2C%22expr%22%3A%22%7Bnamespace%3D%5C%22argocd%5C%22%7D%20%7C~%20%5C%22kratix-state-reconciler%5C%22%22%20%20%7D%5D%2C%22range%22%3A%7B%22from%22%3A%22now-1h%22%2C%22to%22%3A%22now%22%7D%7D'
