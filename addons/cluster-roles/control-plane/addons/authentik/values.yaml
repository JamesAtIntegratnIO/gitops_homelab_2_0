# Authentik Helm Chart Values (2025.12.x)
# Chart: https://github.com/goauthentik/helm
# Docs: https://goauthentik.io/docs/

global:
  # Environment variables for all components (server + worker)
  env:
    - name: AUTHENTIK_SECRET_KEY
      valueFrom:
        secretKeyRef:
          name: authentik-secrets
          key: secret-key
    - name: AUTHENTIK_POSTGRESQL__HOST
      valueFrom:
        secretKeyRef:
          name: authentik-secrets
          key: postgres-host
    - name: AUTHENTIK_POSTGRESQL__PORT
      valueFrom:
        secretKeyRef:
          name: authentik-secrets
          key: postgres-port
    - name: AUTHENTIK_POSTGRESQL__NAME
      valueFrom:
        secretKeyRef:
          name: authentik-secrets
          key: postgres-database
    - name: AUTHENTIK_POSTGRESQL__USER
      valueFrom:
        secretKeyRef:
          name: authentik-secrets
          key: postgres-user
    - name: AUTHENTIK_POSTGRESQL__PASSWORD
      valueFrom:
        secretKeyRef:
          name: authentik-secrets
          key: postgres-password
    - name: AUTHENTIK_REDIS__HOST
      value: "authentik-redis-master.authentik.svc.cluster.local"
    - name: AUTHENTIK_REDIS__PORT
      value: "6379"
    - name: AUTHENTIK_ERROR_REPORTING__ENABLED
      value: "false"
    - name: AUTHENTIK_LOG_LEVEL
      value: "info"
    # Bootstrap admin account
    - name: AUTHENTIK_BOOTSTRAP_PASSWORD
      valueFrom:
        secretKeyRef:
          name: authentik-bootstrap-admin
          key: password
    - name: AUTHENTIK_BOOTSTRAP_EMAIL
      valueFrom:
        secretKeyRef:
          name: authentik-bootstrap-admin
          key: email
    - name: AUTHENTIK_BOOTSTRAP_TOKEN
      valueFrom:
        secretKeyRef:
          name: authentik-bootstrap-admin
          key: token
    # ArgoCD OAuth2 client credentials for blueprint configuration
    - name: ARGOCD_CLIENT_ID
      valueFrom:
        secretKeyRef:
          name: authentik-argocd-oidc
          key: client-id
    - name: ARGOCD_CLIENT_SECRET
      valueFrom:
        secretKeyRef:
          name: authentik-argocd-oidc
          key: client-secret
    # Grafana OAuth2 client credentials for blueprint configuration
    - name: GRAFANA_CLIENT_ID
      valueFrom:
        secretKeyRef:
          name: authentik-grafana-oidc
          key: client-id
    - name: GRAFANA_CLIENT_SECRET
      valueFrom:
        secretKeyRef:
          name: authentik-grafana-oidc
          key: client-secret

  # Affinity preset (new format for 2025.x chart)
  affinity:
    podAntiAffinity: soft

authentik:
  # Disable error reporting for privacy
  error_reporting:
    enabled: false

  # PostgreSQL connection (overridden by env vars from ExternalSecret)
  postgresql:
    host: ""
    port: 5432
    name: ""
    user: ""
    password: ""

  # Email configuration (optional)
  email:
    host: ""
    port: 587
    use_tls: false
    use_ssl: false
    from: ""

  # Outpost configuration
  outposts:
    container_image_base: ghcr.io/goauthentik/%(type)s:%(version)s

# Blueprints configMaps (chart-native blueprint mounting)
blueprints:
  configMaps:
    - authentik-blueprints
  secrets: []

# Server (API/Frontend) configuration
server:
  replicas: 2

  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      memory: 1Gi

  pdb:
    enabled: true
    minAvailable: "1"

  autoscaling:
    enabled: false

  # Metrics / ServiceMonitor
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      interval: 30s
      scrapeTimeout: 3s

  # Ingress disabled - using Gateway API HTTPRoute
  ingress:
    enabled: false

  service:
    type: ClusterIP

# Worker configuration (background tasks)
worker:
  replicas: 1

  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      memory: 1Gi

  # Worker metrics / ServiceMonitor
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      interval: 30s
      scrapeTimeout: 3s

# PostgreSQL subchart disabled (using external)
postgresql:
  enabled: false

# Service account (needed for managed outposts)
serviceAccount:
  create: true

# GeoIP disabled
geoip:
  enabled: false
