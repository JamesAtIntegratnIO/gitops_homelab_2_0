# Authentik Blueprint: Google OAuth Source
# Configures Google as a social login / federation source
# Callback URL to configure in Google Cloud Console:
#   https://auth.cluster.integratn.tech/source/oauth/callback/google/
#
# Prerequisites in Google Cloud Console:
#   1. Enable the "Cloud Identity API" at https://console.cloud.google.com/apis/library/cloudidentity.googleapis.com
#   2. Add the cloud-identity.groups.readonly scope to the OAuth consent screen
#   3. Add the callback URL above as an authorized redirect URI
version: 1
metadata:
  name: google-oauth-source
  labels:
    blueprints.goauthentik.io/instantiate: "true"
context:
  google_client_id: !Env GOOGLE_CLIENT_ID
  google_client_secret: !Env GOOGLE_CLIENT_SECRET
entries:
  # Property mapping to sync Google Workspace group memberships
  - model: authentik_sources_oauth.oauthsourcepropertymapping
    identifiers:
      name: "Google Workspace Groups Sync"
    id: google-groups-mapping
    attrs:
      expression: |
        # Fetch the user's Google Workspace group memberships via Cloud Identity API
        email = info.get("email", "")
        access_token = token.get("access_token", "")
        groups = []
        if email and access_token:
            try:
                # Try with discussion_forum label first, fall back to security label
                labels_to_try = [
                    "cloudidentity.googleapis.com/groups.discussion_forum",
                    "cloudidentity.googleapis.com/groups.security",
                ]
                for label in labels_to_try:
                    query = f"member_key_id == '{email}' && '{label}' in labels"
                    response = requests.get(
                        "https://cloudidentity.googleapis.com/v1/groups/-/memberships:searchDirectGroups",
                        params={"query": query, "pageSize": 200},
                        headers={"Authorization": f"Bearer {access_token}"},
                        timeout=10,
                    )
                    if response.status_code == 200:
                        data = response.json()
                        for membership in data.get("memberships", []):
                            name = membership.get("displayName", "")
                            if name and name not in groups:
                                groups.append(name)
                    else:
                        ak_logger.warning(
                            "Google Groups API error",
                            label=label,
                            status=response.status_code,
                            body=response.text[:500],
                        )
            except Exception as e:
                ak_logger.warning("Google Groups API exception", error=str(e))
        return {"groups": groups}

  # Google OAuth Source
  - model: authentik_sources_oauth.oauthsource
    identifiers:
      slug: google
    id: google-source
    attrs:
      name: Google
      provider_type: google
      consumer_key: !Context google_client_id
      consumer_secret: !Context google_client_secret
      authentication_flow: !Find [authentik_flows.flow, [slug, default-source-authentication]]
      enrollment_flow: !Find [authentik_flows.flow, [slug, default-source-enrollment]]
      user_matching_mode: email_link
      enabled: true
      oidc_well_known_url: "https://accounts.google.com/.well-known/openid-configuration"
      oidc_jwks_url: "https://www.googleapis.com/oauth2/v3/certs"
      additional_scopes: "https://www.googleapis.com/auth/cloud-identity.groups.readonly"
      user_property_mappings:
        - !Find [authentik_sources_oauth.oauthsourcepropertymapping, [name, "Google Workspace Groups Sync"]]
