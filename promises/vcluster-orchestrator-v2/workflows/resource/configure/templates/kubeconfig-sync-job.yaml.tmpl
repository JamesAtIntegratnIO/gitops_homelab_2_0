apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .KubeconfigSyncJobName }}
  namespace: {{ .TargetNamespace }}
  labels:
    app.kubernetes.io/name: kubeconfig-sync
    app.kubernetes.io/managed-by: kratix
    kratix.io/promise-name: {{ .WorkflowContext.PromiseName }}
    kratix.io/resource-name: {{ .Name }}
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 600
  template:
    metadata:
      labels:
        app.kubernetes.io/name: kubeconfig-sync
        app.kubernetes.io/instance: {{ .Name }}
    spec:
      serviceAccountName: {{ .Name }}-kubeconfig-sync
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-kubeconfig
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for secret vc-{{ .Name }} to exist..."
              until [ -f /kubeconfig/config ]; do
                echo "Kubeconfig not found yet, sleeping..."
                sleep 5
              done
              echo "Kubeconfig found!"
          volumeMounts:
            - name: kubeconfig
              mountPath: /kubeconfig
      containers:
        - name: sync-to-onepassword
          image: alpine:3.20
          env:
            - name: OP_CONNECT_HOST
              value: "https://connect.integratn.tech"
            - name: OP_CONNECT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: vcluster-{{ .Name }}-onepassword-token
                  key: token
            - name: OP_VAULT
              valueFrom:
                secretKeyRef:
                  name: vcluster-{{ .Name }}-onepassword-token
                  key: vault
            - name: VCLUSTER_NAME
              value: "{{ .Name }}"
            - name: OP_ITEM_NAME
              value: "{{ .OnePasswordItem }}"
            - name: BASE_DOMAIN
              value: "{{ .BaseDomain }}"
            - name: BASE_DOMAIN_SANITIZED
              value: "{{ .BaseDomainSanitized }}"
            - name: EXTERNAL_SERVER_URL
              value: "{{ .ExternalServerURL }}"
            - name: ARGOCD_ENVIRONMENT
              value: "{{ .ArgoCDEnvironment }}"
          command:
            - sh
            - -c
            - |
              set -e

              apk add --no-cache curl jq >/dev/null 2>&1
              
              echo "=== VCluster Kubeconfig Sync to 1Password ==="
              echo "VCluster: $VCLUSTER_NAME"
              echo "1Password Item: $OP_ITEM_NAME"
              echo "Vault: $OP_VAULT"

              OP_CONNECT_HOST_CLEAN=$(printf '%s' "$OP_CONNECT_HOST" | tr -d '\r\n')
              OP_CONNECT_TOKEN_CLEAN=$(printf '%s' "$OP_CONNECT_TOKEN" | tr -d '\r\n')
              API_BASE="${OP_CONNECT_HOST_CLEAN%/}/v1"
              AUTH_HEADER="Authorization: Bearer ${OP_CONNECT_TOKEN_CLEAN}"

              VAULT_ID="${OP_VAULT:-}"
              VAULT_ID=$(printf '%s' "$VAULT_ID" | tr -d '\r\n')
              if [ -z "$VAULT_ID" ]; then
                VAULT_ID=$(curl -fsS -H "$AUTH_HEADER" "$API_BASE/vaults" | jq -r --arg name "homelab" '.[] | select(.name==$name) | .id' | head -n1)
              fi
              VAULT_ID=$(printf '%s' "$VAULT_ID" | tr -d '\r\n')
              if [ -z "$VAULT_ID" ]; then
                echo "Vault not found: homelab"
                exit 1
              fi
              
              # Read kubeconfig from secret
              KUBECONFIG_CONTENT=$(cat /kubeconfig/config)
              
              # Build ArgoCD cluster config
              ARGOCD_CONFIG=$(cat <<EOF
              {
                "tlsClientConfig": {
                  "insecure": false
                }
              }
              EOF
              )
              
              # Check if item exists
              echo "Checking if item exists..."
              ITEM_SEARCH=$(curl -fsS -X POST "$API_BASE/vaults/$VAULT_ID/items" \
                -H "$AUTH_HEADER" \
                -H "Content-Type: application/json" \
                -d "{\"title\":\"$OP_ITEM_NAME\"}" || echo "{}")
              
              ITEM_ID=$(echo "$ITEM_SEARCH" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4 || echo "")
              
              if [ -z "$ITEM_ID" ]; then
                echo "Creating new 1Password item..."
                RESPONSE=$(curl -fsS -X POST "$API_BASE/vaults/$VAULT_ID/items" \
                  -H "$AUTH_HEADER" \
                  -H "Content-Type: application/json" \
                  -d "{
                    \"title\": \"$OP_ITEM_NAME\",
                    \"category\": \"SERVER\",
                    \"tags\": [\"vcluster\", \"kubeconfig\", \"$ARGOCD_ENVIRONMENT\"],
                    \"fields\": [
                      {
                        \"id\": \"kubeconfig\",
                        \"type\": \"CONCEALED\",
                        \"label\": \"kubeconfig\",
                        \"value\": $(echo "$KUBECONFIG_CONTENT" | jq -Rs .)
                      },
                      {
                        \"id\": \"argocd-name\",
                        \"type\": \"STRING\",
                        \"label\": \"argocd-name\",
                        \"value\": \"$VCLUSTER_NAME.$BASE_DOMAIN_SANITIZED\"
                      },
                      {
                        \"id\": \"argocd-server\",
                        \"type\": \"STRING\",
                        \"label\": \"argocd-server\",
                        \"value\": \"$EXTERNAL_SERVER_URL\"
                      },
                      {
                        \"id\": \"argocd-config\",
                        \"type\": \"CONCEALED\",
                        \"label\": \"argocd-config\",
                        \"value\": $(echo "$ARGOCD_CONFIG" | jq -Rc .)
                      }
                    ]
                  }")
                ITEM_ID=$(echo "$RESPONSE" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)
                if [ -z "$ITEM_ID" ]; then
                  echo "Failed to create 1Password item: $OP_ITEM_NAME"
                  exit 1
                fi
                echo "Created item with ID: $ITEM_ID"
              else
                echo "Updating existing item ID: $ITEM_ID"
                curl -fsS -X PATCH "$API_BASE/vaults/$VAULT_ID/items/$ITEM_ID" \
                  -H "$AUTH_HEADER" \
                  -H "Content-Type: application/json" \
                  -d "{
                    \"fields\": [
                      {
                        \"id\": \"kubeconfig\",
                        \"value\": $(echo "$KUBECONFIG_CONTENT" | jq -Rs .)
                      },
                      {
                        \"id\": \"argocd-name\",
                        \"value\": \"$VCLUSTER_NAME.$BASE_DOMAIN_SANITIZED\"
                      },
                      {
                        \"id\": \"argocd-server\",
                        \"value\": \"$EXTERNAL_SERVER_URL\"
                      },
                      {
                        \"id\": \"argocd-config\",
                        \"value\": $(echo "$ARGOCD_CONFIG" | jq -Rc .)
                      }
                    ]
                  }"
              fi
              
              echo "âœ“ Kubeconfig synced to 1Password successfully"
          volumeMounts:
            - name: kubeconfig
              mountPath: /kubeconfig
              readOnly: true
      volumes:
        - name: kubeconfig
          secret:
            secretName: vc-{{ .Name }}
            optional: false
