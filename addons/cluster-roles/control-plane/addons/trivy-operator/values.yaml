# trivy-operator values for control-plane clusters
# Scans workload images for vulnerabilities, misconfigurations, and exposed secrets.

# Exclude system namespaces that run trusted images and would generate noise
excludeNamespaces: "kube-system,kube-public,kube-node-lease"

# Disable node collector — requires hostPID and hostPath which violate
# PodSecurity "baseline" and fail on Talos (immutable root filesystem,
# no /etc/systemd or /lib/systemd). The chart has no nodeCollector.enabled toggle;
# infra assessment scanner controls node-collector job creation.
nodeCollector:
  excludeNodes: ""

# Security hardening — fixes AVD-KSV-0030 / AVD-KSV-0104
podSecurityContext:
  seccompProfile:
    type: RuntimeDefault

securityContext:
  privileged: false
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  capabilities:
    drop: [ALL]
  seccompProfile:
    type: RuntimeDefault

operator:
  # Disable infra assessment scanning — node-collector can't run on Talos
  infraAssessmentScannerEnabled: false
  # Conservative concurrency for homelab resource constraints
  scanJobsConcurrentLimit: 3
  scanJobTimeout: 10m
  # Clean up completed scan jobs after 30s
  scanJobTTL: 30s

trivy:
  # Standalone mode — no Trivy server needed
  mode: Standalone
  # Only report actionable severities
  severity: LOW,MEDIUM,HIGH,CRITICAL
  # Resource limits for scan jobs — raised CPU to reduce CPUThrottling alerts
  resources:
    requests:
      cpu: 200m
      memory: 200M
    limits:
      cpu: "1"    # Raised from 500m — scan jobs CPU-throttle and fail
      memory: 500M

# Enable Prometheus ServiceMonitor for metrics scraping
serviceMonitor:
  enabled: true
  labels:
    release: kube-prometheus-stack
  honorLabels: true
