argocd:
  enabled: true
  chartName: argo-cd
  namespace: argocd
  releaseName: argo-cd
  project: platform
  defaultVersion: "9.0.3"
  chartRepository: "https://argoproj.github.io/argo-helm"
  selector:
    matchExpressions:
      - key: enable_argocd
        operator: In
        values: ['true']
argocd-projects:
  enabled: true
  type: manifest
  namespace: argocd
  path: addons/environments/production/addons/argocd-projects
  selector:
    matchExpressions:
      - key: enable_argocd
        operator: In
        values: ['true']
  annotationsApp:
    argocd.argoproj.io/sync-wave: "-2"
  syncPolicy:
    automated:
      selfHeal: false
      allowEmpty: true
      prune: true
    retry:
      limit: -1
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 10m
    syncOptions:
      - CreateNamespace=true
      - SkipDryRunOnMissingResource=true
iam-chart:
  enabled: false
  enableAckPodIdentity: false 
  namespace: ack-system
  defaultVersion: "1.3.13"
  chartNamespace: aws-controllers-k8s
  chartRepository: public.ecr.aws
  selector:
    matchExpressions:
      - key: enable_ack_iam
        operator: In
        values: ['true']
  environments:
  - selector:
      environment: staging
      tenant: tenant1
    chartVersion: "7.6.12"
  valuesObject:
    aws:
      region: '{{.metadata.annotations.aws_region}}'
    serviceAccount:
      name: '{{.metadata.annotations.ack_iam_service_account}}'
ack-eks:
  enabled: false
  enableAckPodIdentity: false 
  namespace: ack-system
  chartName: eks-chart
  defaultVersion: "1.5.1"
  chartNamespace: aws-controllers-k8s
  chartRepository: public.ecr.aws
  selector:
    matchExpressions:
      - key: enable_ack_eks
        operator: In
        values: ['true']
  valuesObject:
    aws:
      region: '{{.metadata.annotations.aws_region}}'
    serviceAccount:
      name: '{{.metadata.annotations.ack_eks_service_account}}'
ack-acm:
  enabled: false
  enableAckPodIdentity: true
  namespace: ack-system
  chartName: acm-chart
  defaultVersion: "1.0.2"
  chartNamespace: aws-controllers-k8s
  chartRepository: public.ecr.aws
  selector:
    matchExpressions:
      - key: enable_ack_acm
        operator: In
        values: ['true']
  valuesObject:
    aws:
      region: '{{.metadata.annotations.aws_region}}'
    serviceAccount:
      name:  'ack-acm-controller'
      annotations:
        eks.amazonaws.com/role-arn: '{{default "" (index .metadata.annotations "ack_acm_role_arn")}}'
route53-chart:
  enabled: false
  enableAckPodIdentity: false
  namespace: ack-system
  chartName: route53-chart
  defaultVersion: "0.0.20"
  chartNamespace: aws-controllers-k8s
  chartRepository: public.ecr.aws
  selector:
    matchExpressions:
      - key: enable_route53_controller
        operator: In
        values: ['true']
  valuesObject:
    aws:
      region: '{{.metadata.annotations.aws_region}}'
    serviceAccount:
      name:  'route53-controller'
      annotations:
        eks.amazonaws.com/role-arn: '{{default "" (index .metadata.annotations "ack_route53_controller_role_arn")}}'
external-secrets:
  enabled: true
  enableAckPodIdentity: false
  namespace: external-secrets
  chartName: external-secrets
  project: platform-services
  defaultVersion: "0.10.3"
  chartRepository: "https://charts.external-secrets.io"
  selector:
    matchExpressions:
      - key: enable_external_secrets
        operator: In
        values: ['true']
  valuesObject:
    installCRDs: true
    serviceAccount:
      name: "external-secrets-sa"
      annotations:
        eks.amazonaws.com/role-arn: '{{default "" (index .metadata.annotations "external_secrets_iam_role_arn")}}'
    extraObjects:
      - apiVersion: external-secrets.io/v1beta1
        kind: ClusterSecretStore
        metadata:
          name: onepassword-store
          labels:
            integratn.tech/cluster-secret-store: onepassword-store
        spec:
          provider:
            onepassword:
              connectHost: https://connect.integratn.tech
              vaults:
                homelab: 1
              auth:
                secretRef:
                  connectTokenSecretRef:
                    name: eso-onepassword-token
                    namespace: external-secrets
                    key: token
  syncPolicy:
    automated:
      selfHeal: false
      allowEmpty: true
      prune: true
    retry:
      limit: -1
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 10m
    syncOptions:
      - CreateNamespace=true
      - SkipDryRunOnMissingResource=true
  ignoreDifferences:
    - kind: Secret
      name: external-secrets-webhook
      jsonPointers:
        - /data
    - kind: Service
      name: external-secrets-webhook
      jsonPointers:
        - /spec/clusterIP
        - /spec/clusterIPs
aws-load-balancer-controller:
  enabled: false
  enableAckPodIdentity: true
  namespace: kube-system
  defaultVersion: "1.8.4"
  chartRepository: "https://aws.github.io/eks-charts"
  selector:
    matchExpressions:
      - key: enable_aws_load_balancer_controller
        operator: In
        values: ['true']
  valuesObject:
    serviceAccount:
      name:  "aws-load-balancer-controller-sa"
    vpcId: '{{.metadata.annotations.aws_vpc_id}}'
    clusterName: '{{.name}}'
  ignoreDifferences:
    - kind: Secret
      name: aws-load-balancer-tls
      jsonPointers: [/data]
    - group: admissionregistration.k8s.io
      kind: MutatingWebhookConfiguration
      jqPathExpressions: ['.webhooks[].clientConfig.caBundle']
    - group: admissionregistration.k8s.io
      kind: ValidatingWebhookConfiguration
      jqPathExpressions: ['.webhooks[].clientConfig.caBundle']
metrics-server:
  enabled: false
  namespace: kube-system
  project: platform-services
  defaultVersion: "3.11.0"
  chartRepository: "https://kubernetes-sigs.github.io/metrics-server"
  selector:
    matchExpressions:
      - key: enable_metrics_server
        operator: In
        values: ['true']
karpenter:
  enabled: false
  enableAckPodIdentity: false
  releaseName: karpenter
  namespace: 'karpenter'
  chartName: karpenter/karpenter
  chartRepository: public.ecr.aws
  defaultVersion: "1.0.4"
  selector:
    matchExpressions:
      - key: enable_karpenter
        operator: In
        values: ['true']
  valuesObject:
    settings:
      clusterName: '{{.metadata.annotations.aws_cluster_name}}'
      interruptionQueue: '{{.metadata.annotations.karpenter_sqs_queue_name}}'
    serviceAccount:
      name: '{{.metadata.annotations.karpenter_service_account}}'
      annotations:
        eks.amazonaws.com/role-arn: '{{.metadata.annotations.karpenter_iam_role_arn}}'
aws_efs_csi_driver:
  enabled: false
  enableAckPodIdentity: false
  releaseName: aws-efs-csi-driver
  namespace: "kube-sytem"
  chartName: aws-efs-csi-driver
  chartRepository: https://kubernetes-sigs.github.io/aws-efs-csi-driver
  defaultVersion: "3.0.7"
  selector:
    matchExpressions:
      - key: enable_aws_efs_csi_driver
        operator: In
        values: ['true']
  valuesObject:
    controller:
      serviceAccount:
        name: '{{default "" (index  .metadata.annotations aws_efs_csi_driver_controller_service_account)}}'
        annotations:
          eks.amazonaws.com/role-arn: '{{default "" (index .metadata.annotations aws_efs_csi_driver_iam_role_arn)}}'
    node:
      serviceAccount:
        name: '{{.metadata.annotations.aws_efs_csi_driver_node_service_account}}'
        annotations:
          eks.amazonaws.com/role-arn: '{{.metadata.annotations.aws_efs_csi_driver_iam_role_arn}}'
nfs-subdir-external-provisioner:
  enabled: true
  namespace: '{{.metadata.annotations.nfs_subdir_external_provisioner_namespace}}'
  chartName: nfs-subdir-external-provisioner
  project: platform-services
  chartRepository: https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/
  defaultVersion: "4.0.18"
  valuesObject:
    storageClass:
      create: false
    nfs:
      server: 10.0.0.12
      path: /mnt/user/kube_storage
  selector:
    matchExpressions:
      - key: akuity.io/argo-cd-cluster-name
        operator: NotIn
        values: [in-cluster]
      - key: enable_nfs_subdir_external_provisioner
        operator: In
        values: ['true']
      - key: aws_cluster_name
        operator: DoesNotExist
  additionalResources:
    type: manifest
    # Applied from: addons/environments/production/addons/nfs-subdir-external-provisioner
    path: addons/environments/production/addons/nfs-subdir-external-provisioner
  syncPolicy:
    automated: {}
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
kro:
  enabled: false
  namespace: kro-system
  defaultVersion: "0.2.1"
  chartName: kro
  chartNamespace: kro
  chartRepository: ghcr.io/kro-run
  selector:
    matchExpressions:
      - key: enable_kro
        operator: In
        values: ['true']
kro-resource-groups:
  enabled: false
  type: manifest
  namespace: kro-resource-groups
  defaultVersion: "0.1.0"
  path: kro/resource-groups
  selector:
    matchExpressions:
      - key: enable_kro_resource_groups
        operator: In
        values: ['true']
external-dns:
  enabled: true
  releaseName: external-dns
  namespace: '{{.metadata.annotations.external_dns_namespace}}'
  chartName: external-dns
  project: platform-services
  chartRepository: https://kubernetes-sigs.github.io/external-dns
  defaultVersion: "1.19.0"
  selector:
    matchExpressions:
      - key: enable_external_dns
        operator: In
        values: ['true']

cert-manager:
  enabled: true
  releaseName: cert-manager
  namespace: '{{.metadata.annotations.cert_manager_namespace}}'
  chartName: cert-manager
  project: platform-services
  chartRepository: https://charts.jetstack.io
  defaultVersion: "v1.16.2"
  annotationsApp:
    argocd.argoproj.io/sync-wave: "-1"
  selector:
    matchExpressions:
      - key: enable_cert_manager
        operator: In
        values: ['true']
  valuesObject:
    crds:
      enabled: true
    clusterResourceNamespace: '{{.metadata.annotations.cert_manager_namespace}}'
    global:
      leaderElection:
        namespace: '{{.metadata.annotations.cert_manager_namespace}}'
  syncPolicy:
    automated: {}
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      - SkipDryRunOnMissingResource=true
kratix:
  enabled: true
  namespace: kratix-platform-system
  chartName: kratix
  project: platform
  chartRepository: https://syntasso.github.io/helm-charts
  defaultVersion: "0.0.1"
  selector:
    matchExpressions:
      - key: enable_kratix
        operator: In
        values: ['true']
  syncPolicy:
    automated:
      selfHeal: false
      allowEmpty: true
      prune: false
    retry:
      limit: -1 # number of failed sync attempt retries; unlimited number of attempts if less than 0
      backoff:
        duration: 5s # the amount to back off. Default unit is seconds, but could also be a duration (e.g. "2m", "1h")
        factor: 2 # a factor to multiply the base duration after each failed retry
        maxDuration: 10m # the maximum amount of time allowed for the backoff strategy
    syncOptions:
      - CreateNamespace=true
    # metadata:
    #   annotations:
    #     argocd.argoproj.io/sync-wave: "1"

metallb:
  enabled: true
  namespace: metallb-system
  releaseName: metallb
  project: platform-services
  defaultVersion: "0.14.5"
  chartRepository: "https://metallb.github.io/metallb"
  additionalResources:
    type: manifests
    # Required by the template; for "manifests" it uses `manifestPath` below.
    path: "clusters"
    # Applied from: addons/clusters/{{ .nameNormalized }}/addons/metallb-pool
    manifestPath: addons/metallb-pool
  syncPolicyAppSet:
    preserveResourcesOnDeletion: true
  selector:
    matchExpressions:
      - key: enable_metallb
        operator: In
        values: ['true']
  syncPolicy:
    automated: {}
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true # Big CRDs.
      - RespectIgnoreDifferences=true
    managedNamespaceMetadata:
      labels:
        kubernetes.io/metadata.name: metallb-system
        pod-security.kubernetes.io/audit: privileged
        pod-security.kubernetes.io/enforce: privileged
        pod-security.kubernetes.io/enforce-version: latest
        pod-security.kubernetes.io/warn: privileged
  ignoreDifferences:
    - group: "apiextensions.k8s.io"
      kind: CustomResourceDefinition
      name: bgppeers.metallb.io
      jsonPointers:
        - /spec/conversion/webhook/clientConfig/caBundle
    - group: "apiextensions.k8s.io"
      kind: CustomResourceDefinition
      name: addresspools.metallb.io
      jsonPointers:
        - /spec/conversion/webhook/clientConfig/caBundle
    - group: admissionregistration.k8s.io
      kind: ValidatingWebhookConfiguration
      jqPathExpressions:
        - .webhooks[]?.clientConfig.caBundle
    - group: apps
      kind: DaemonSet
      jqPathExpressions:
        - .spec.template.spec.initContainers[]?.resources

metallb-config:
  enabled: true
  type: manifest
  namespace: metallb-system
  project: platform-services
  path: addons/environments/production/addons/metallb-config
  annotationsApp:
    argocd.argoproj.io/sync-wave: "10"
  selector:
    matchExpressions:
      - key: enable_metallb
        operator: In
        values: ['true']
  syncPolicy:
    automated: {}
    retry:
      limit: 30
      backoff:
        duration: 10s
        factor: 2
        maxDuration: 5m
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      - SkipDryRunOnMissingResource=true

vcluster-coredns-config:
  enabled: true
  type: manifest
  namespace: kube-system
  project: platform-services
  path: addons/environments/production/addons/coredns
  selector:
    matchExpressions:
      - key: cluster_role
        operator: In
        values: ['worker']
      - key: cluster_type
        operator: DoesNotExist
      - key: cluster_name
        operator: NotIn
        values: ['media']
  syncPolicy:
    automated: {}
    syncOptions:
      - CreateNamespace=true
      - SkipDryRunOnMissingResource=true
  ignoreDifferences:
    - kind: ConfigMap
      jsonPointers:
        - /data/NodeHosts

gateway-api-crds:
  enabled: true
  type: manifest
  namespace: kube-system
  project: platform-services
  defaultVersion: v1.4.0
  annotationsApp:
    argocd.argoproj.io/sync-wave: "0"
  selector:
    matchExpressions:
      - key: enable_gateway_api_crds
        operator: In
        values: ['true']
  generatorValues:
    gatewayAPIRevision: v1.4.0
  manifestSource:
    repoURL: https://github.com/kubernetes-sigs/gateway-api.git
    path: config/crd/standard
    directory:
      recurse: true
    targetRevisionFromValue: gatewayAPIRevision
  syncPolicy:
    automated: {}
    syncOptions:
      - ApplyOutOfSyncOnly=true
      - ServerSideApply=true

nginx-gateway-fabric:
  enabled: true
  namespace: nginx-gateway
  releaseName: nginx-gateway-fabric
  chartName: nginx-gateway-fabric
  project: platform-services
  chartRepository: oci://ghcr.io/nginx/charts/nginx-gateway-fabric
  defaultVersion: "2.2.2"
  annotationsApp:
    argocd.argoproj.io/sync-wave: "10"
  selector:
    matchExpressions:
      - key: enable_nginx_gateway_fabric
        operator: In
        values: ['true']
  syncPolicy:
    automated: {}
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
