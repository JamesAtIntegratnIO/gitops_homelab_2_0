{{ if .BackingStore }}{{ if .BackingStore.etcd }}{{ if .BackingStore.etcd.deploy }}{{ if .BackingStore.etcd.deploy.enabled }}---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: {{ .Name }}-etcd-ca
  namespace: {{ .TargetNamespace }}
  labels:
    app.kubernetes.io/name: etcd-ca
    app.kubernetes.io/instance: {{ .Name }}
    app.kubernetes.io/managed-by: kratix
    kratix.io/promise-name: {{ .WorkflowContext.PromiseName }}
    kratix.io/resource-name: {{ .Name }}
spec:
  isCA: true
  commonName: {{ .Name }}-etcd-ca
  secretName: {{ .Name }}-etcd-ca
  privateKey:
    algorithm: RSA
    size: 2048
  issuerRef:
    name: {{ .Name }}-etcd-selfsigned
    kind: Issuer
    group: cert-manager.io
---
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: {{ .Name }}-etcd-selfsigned
  namespace: {{ .TargetNamespace }}
  labels:
    app.kubernetes.io/name: etcd-issuer
    app.kubernetes.io/instance: {{ .Name }}
    app.kubernetes.io/managed-by: kratix
    kratix.io/promise-name: {{ .WorkflowContext.PromiseName }}
    kratix.io/resource-name: {{ .Name }}
spec:
  selfSigned: {}
---
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: {{ .Name }}-etcd-ca
  namespace: {{ .TargetNamespace }}
  labels:
    app.kubernetes.io/name: etcd-ca-issuer
    app.kubernetes.io/instance: {{ .Name }}
    app.kubernetes.io/managed-by: kratix
    kratix.io/promise-name: {{ .WorkflowContext.PromiseName }}
    kratix.io/resource-name: {{ .Name }}
spec:
  ca:
    secretName: {{ .Name }}-etcd-ca
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Name }}-etcd-certs-merge
  namespace: {{ .TargetNamespace }}
  labels:
    app.kubernetes.io/name: etcd-certs-job
    app.kubernetes.io/instance: {{ .Name }}
    app.kubernetes.io/managed-by: kratix
    kratix.io/promise-name: {{ .WorkflowContext.PromiseName }}
    kratix.io/resource-name: {{ .Name }}
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        app: etcd-certs-merge
    spec:
      restartPolicy: OnFailure
      serviceAccountName: vc-{{ .Name }}
      containers:
      - name: merge-certs
        image: bitnami/kubectl:latest
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "Waiting for certificates to be ready..."
          
          # Wait for CA cert
          until kubectl get secret {{ .Name }}-etcd-ca -n {{ .TargetNamespace }} 2>/dev/null; do
            echo "Waiting for CA certificate..."
            sleep 2
          done
          
          # Wait for server cert
          until kubectl get secret {{ .Name }}-etcd-server -n {{ .TargetNamespace }} 2>/dev/null; do
            echo "Waiting for server certificate..."
            sleep 2
          done
          
          # Wait for peer cert
          until kubectl get secret {{ .Name }}-etcd-peer -n {{ .TargetNamespace }} 2>/dev/null; do
            echo "Waiting for peer certificate..."
            sleep 2
          done
          
          echo "All certificates ready, merging..."
          
          # Extract certs
          CA_CRT=$(kubectl get secret {{ .Name }}-etcd-ca -n {{ .TargetNamespace }} -o jsonpath='{.data.tls\.crt}')
          SERVER_CRT=$(kubectl get secret {{ .Name }}-etcd-server -n {{ .TargetNamespace }} -o jsonpath='{.data.tls\.crt}')
          SERVER_KEY=$(kubectl get secret {{ .Name }}-etcd-server -n {{ .TargetNamespace }} -o jsonpath='{.data.tls\.key}')
          PEER_CRT=$(kubectl get secret {{ .Name }}-etcd-peer -n {{ .TargetNamespace }} -o jsonpath='{.data.tls\.crt}')
          PEER_KEY=$(kubectl get secret {{ .Name }}-etcd-peer -n {{ .TargetNamespace }} -o jsonpath='{.data.tls\.key}')
          
          # Create merged secret
          kubectl create secret generic {{ .Name }}-certs -n {{ .TargetNamespace }} \
            --from-literal=etcd-ca.crt="$(echo $CA_CRT | base64 -d)" \
            --from-literal=etcd-server.crt="$(echo $SERVER_CRT | base64 -d)" \
            --from-literal=etcd-server.key="$(echo $SERVER_KEY | base64 -d)" \
            --from-literal=etcd-peer.crt="$(echo $PEER_CRT | base64 -d)" \
            --from-literal=etcd-peer.key="$(echo $PEER_KEY | base64 -d)" \
            --dry-run=client -o yaml | kubectl apply -f -
          
          echo "Certificate merge complete!"
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: {{ .Name }}-etcd-server
  namespace: {{ .TargetNamespace }}
  labels:
    app.kubernetes.io/name: etcd-server-cert
    app.kubernetes.io/instance: {{ .Name }}
    app.kubernetes.io/managed-by: kratix
    kratix.io/promise-name: {{ .WorkflowContext.PromiseName }}
    kratix.io/resource-name: {{ .Name }}
spec:
  secretName: {{ .Name }}-etcd-server
  commonName: {{ .Name }}-etcd
  dnsNames:
    - {{ .Name }}-etcd
    - {{ .Name }}-etcd.{{ .TargetNamespace }}
    - {{ .Name }}-etcd.{{ .TargetNamespace }}.svc
    - {{ .Name }}-etcd.{{ .TargetNamespace }}.svc.cluster.local
    - {{ .Name }}-etcd-headless
    - {{ .Name }}-etcd-headless.{{ .TargetNamespace }}
    - {{ .Name }}-etcd-headless.{{ .TargetNamespace }}.svc
    - {{ .Name }}-etcd-headless.{{ .TargetNamespace }}.svc.cluster.local
    - {{ .Name }}-etcd-0
    - {{ .Name }}-etcd-0.{{ .Name }}-etcd-headless.{{ .TargetNamespace }}
    - {{ .Name }}-etcd-0.{{ .Name }}-etcd-headless.{{ .TargetNamespace }}.svc
    - {{ .Name }}-etcd-0.{{ .Name }}-etcd-headless.{{ .TargetNamespace }}.svc.cluster.local
    - {{ .Name }}-etcd-1
    - {{ .Name }}-etcd-1.{{ .Name }}-etcd-headless.{{ .TargetNamespace }}
    - {{ .Name }}-etcd-1.{{ .Name }}-etcd-headless.{{ .TargetNamespace }}.svc
    - {{ .Name }}-etcd-1.{{ .Name }}-etcd-headless.{{ .TargetNamespace }}.svc.cluster.local
    - {{ .Name }}-etcd-2
    - {{ .Name }}-etcd-2.{{ .Name }}-etcd-headless.{{ .TargetNamespace }}
    - {{ .Name }}-etcd-2.{{ .Name }}-etcd-headless.{{ .TargetNamespace }}.svc
    - {{ .Name }}-etcd-2.{{ .Name }}-etcd-headless.{{ .TargetNamespace }}.svc.cluster.local
    - localhost
  ipAddresses:
    - 127.0.0.1
  privateKey:
    algorithm: RSA
    size: 2048
  usages:
    - server auth
    - client auth
  issuerRef:
    name: {{ .Name }}-etcd-ca
    kind: Issuer
    group: cert-manager.io
  secretTemplate:
    labels:
      app.kubernetes.io/name: etcd-server-cert
      app.kubernetes.io/instance: {{ .Name }}
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: {{ .Name }}-etcd-peer
  namespace: {{ .TargetNamespace }}
  labels:
    app.kubernetes.io/name: etcd-peer-cert
    app.kubernetes.io/instance: {{ .Name }}
    app.kubernetes.io/managed-by: kratix
    kratix.io/promise-name: {{ .WorkflowContext.PromiseName }}
    kratix.io/resource-name: {{ .Name }}
spec:
  secretName: {{ .Name }}-etcd-peer
  commonName: {{ .Name }}-etcd
  dnsNames:
    - {{ .Name }}-etcd
    - {{ .Name }}-etcd.{{ .TargetNamespace }}
    - {{ .Name }}-etcd.{{ .TargetNamespace }}.svc
    - {{ .Name }}-etcd.{{ .TargetNamespace }}.svc.cluster.local
    - {{ .Name }}-etcd-headless
    - {{ .Name }}-etcd-headless.{{ .TargetNamespace }}
    - {{ .Name }}-etcd-headless.{{ .TargetNamespace }}.svc
    - {{ .Name }}-etcd-headless.{{ .TargetNamespace }}.svc.cluster.local
    - {{ .Name }}-etcd-0
    - {{ .Name }}-etcd-0.{{ .Name }}-etcd-headless.{{ .TargetNamespace }}
    - {{ .Name }}-etcd-0.{{ .Name }}-etcd-headless.{{ .TargetNamespace }}.svc
    - {{ .Name }}-etcd-0.{{ .Name }}-etcd-headless.{{ .TargetNamespace }}.svc.cluster.local
    - {{ .Name }}-etcd-1
    - {{ .Name }}-etcd-1.{{ .Name }}-etcd-headless.{{ .TargetNamespace }}
    - {{ .Name }}-etcd-1.{{ .Name }}-etcd-headless.{{ .TargetNamespace }}.svc
    - {{ .Name }}-etcd-1.{{ .Name }}-etcd-headless.{{ .TargetNamespace }}.svc.cluster.local
    - {{ .Name }}-etcd-2
    - {{ .Name }}-etcd-2.{{ .Name }}-etcd-headless.{{ .TargetNamespace }}
    - {{ .Name }}-etcd-2.{{ .Name }}-etcd-headless.{{ .TargetNamespace }}.svc
    - {{ .Name }}-etcd-2.{{ .Name }}-etcd-headless.{{ .TargetNamespace }}.svc.cluster.local
  privateKey:
    algorithm: RSA
    size: 2048
  usages:
    - server auth
    - client auth
  issuerRef:
    name: {{ .Name }}-etcd-ca
    kind: Issuer
    group: cert-manager.io
  secretTemplate:
    labels:
      app.kubernetes.io/name: etcd-peer-cert
      app.kubernetes.io/instance: {{ .Name }}
{{ end }}{{ end }}{{ end }}{{ end }}
