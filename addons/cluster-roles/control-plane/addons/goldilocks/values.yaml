# Goldilocks - VPA-based resource recommendation and auto-tuning
# VPA runs in Auto mode: it will actually set requests/limits on pods
# ArgoCD is configured to ignore resource drift so it doesn't fight VPA

# VPA subchart — enables all 3 components for Auto mode
vpa:
  enabled: true
  admissionController:
    enabled: true
  updater:
    enabled: true
  recommender:
    extraArgs:
      v: "4"
      pod-recommendation-min-cpu-millicores: 15
      pod-recommendation-min-memory-mb: 100
      # Increase margin from default 0.15 (15%) to 0.40 (40%)
      # Gives VPA recommendations more headroom so HPA memory
      # utilization stays well below the 50% target threshold
      recommendation-margin-fraction: "0.40"

# Controller — creates VPA objects for workloads automatically
controller:
  enabled: true
  rbac:
    create: true
    enableArgoproj: true
    extraRules:
      # Goldilocks needs services access to resolve owner chains for pods
      # managed by service-backed controllers (e.g. vcluster StatefulSets)
      - apiGroups: [""]
        resources: ["services"]
        verbs: ["get", "list", "watch"]
  flags:
    # Monitor all namespaces without requiring opt-in labels
    on-by-default: "true"
    # Exclude system namespaces and trivy-system (ephemeral scan jobs
    # create unresolvable owner chains that spam controller logs)
    exclude-namespaces: "kube-system,kube-public,kube-node-lease,goldilocks,trivy-system"
    # VPA update mode is controlled per-namespace via label:
    # goldilocks.fairwinds.com/vpa-update-mode=Auto
  resources:
    requests:
      cpu: 25m
      memory: 256Mi
    limits:
      memory: 512Mi

# Dashboard — web UI for viewing resource recommendations
dashboard:
  enabled: true
  replicaCount: 1
  flags:
    on-by-default: "true"
  resources:
    requests:
      cpu: 25m
      memory: 256Mi
    limits:
      memory: 512Mi
  # Expose via Gateway API HTTPRoute
  httpRoute:
    enabled: true
    parentRefs:
      - name: nginx-gateway
        namespace: nginx-gateway
        sectionName: https
    hostnames:
      - goldilocks.cluster.integratn.tech
    matches:
      - path:
          type: PathPrefix
          value: /
