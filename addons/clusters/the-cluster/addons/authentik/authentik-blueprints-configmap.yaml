---
# ConfigMap containing Authentik blueprints for code-driven configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: authentik-blueprints
  namespace: authentik
data:
  00-admin-group.yaml: |
    # Authentik Blueprint: Admin Group
    # Creates a superuser admin group for platform administrators
    version: 1
    metadata:
      name: admin-group
      labels:
        blueprints.goauthentik.io/instantiate: "true"
    entries:
      - model: authentik_core.group
        identifiers:
          name: authentik Admins
        attrs:
          is_superuser: true
          parent: null
        id: admin-group

  01-argocd-provider.yaml: |
    # Authentik Blueprint: ArgoCD OAuth2 Provider
    # Creates OAuth2/OIDC provider for ArgoCD integration
    version: 1
    metadata:
      name: argocd-provider
      labels:
        blueprints.goauthentik.io/instantiate: "true"
    context:
      client_id: !Env ARGOCD_CLIENT_ID
      client_secret: !Env ARGOCD_CLIENT_SECRET
    entries:
      # Custom scope mapping for groups (must come before provider that references it)
      - model: authentik_providers_oauth2.scopemapping
        identifiers:
          name: ArgoCD Groups Scope
          scope_name: groups
        id: groups-scope
        attrs:
          expression: |
            return {
              "groups": [group.name for group in user.ak_groups.all()],
            }
      
      # OAuth2/OIDC Provider
      - model: authentik_providers_oauth2.oauth2provider
        identifiers:
          name: argocd-provider
        id: argocd-provider
        attrs:
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
          client_type: confidential
          client_id: !Context client_id
          client_secret: !Context client_secret
          redirect_uris:
            - url: https://argocd.cluster.integratn.tech/auth/callback
              matching_mode: strict
            - url: https://argocd.cluster.integratn.tech/api/dex/callback
              matching_mode: strict
          signing_key: !Find [authentik_crypto.certificatekeypair, [name, "authentik Self-signed Certificate"]]
          property_mappings:
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, "openid"]]
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, "email"]]
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, "profile"]]
            - !Find [authentik_providers_oauth2.scopemapping, [name, "ArgoCD Groups Scope"]]
          include_claims_in_id_token: true
          issuer_mode: per_provider
          sub_mode: hashed_user_id
          access_code_validity: minutes=10
          access_token_validity: minutes=60
          refresh_token_validity: days=30
      
      # Application
      - model: authentik_core.application
        identifiers:
          slug: argocd
        attrs:
          name: ArgoCD
          provider: !Find [authentik_providers_oauth2.oauth2provider, [name, argocd-provider]]
          open_in_new_tab: true
          launch_url: https://argocd.cluster.integratn.tech
          group: Platform Services
          meta_icon: https://cncf-branding.netlify.app/img/projects/argo/icon/color/argo-icon-color.png
          meta_description: GitOps Continuous Delivery
          policy_engine_mode: all

  02-grafana-provider.yaml: |
    # Authentik Blueprint: Grafana OAuth2 Provider
    # Creates OAuth2/OIDC provider for Grafana integration
    version: 1
    metadata:
      name: grafana-provider
      labels:
        blueprints.goauthentik.io/instantiate: "true"
    context:
      client_id: !Env GRAFANA_CLIENT_ID
      client_secret: !Env GRAFANA_CLIENT_SECRET
    entries:
      # Custom scope mapping for groups (must come before provider that references it)
      - model: authentik_providers_oauth2.scopemapping
        identifiers:
          name: Grafana Groups Scope
          scope_name: groups
        id: groups-scope
        attrs:
          expression: |
            return {
              "groups": [group.name for group in user.ak_groups.all()],
            }
      
      # OAuth2/OIDC Provider
      - model: authentik_providers_oauth2.oauth2provider
        identifiers:
          name: grafana-provider
        id: grafana-provider
        attrs:
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
          client_type: confidential
          client_id: !Context client_id
          client_secret: !Context client_secret
          redirect_uris:
            - url: https://grafana.cluster.integratn.tech/login/generic_oauth
              matching_mode: strict
          signing_key: !Find [authentik_crypto.certificatekeypair, [name, "authentik Self-signed Certificate"]]
          property_mappings:
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, "openid"]]
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, "email"]]
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, "profile"]]
            - !Find [authentik_providers_oauth2.scopemapping, [name, "Grafana Groups Scope"]]
          include_claims_in_id_token: true
          issuer_mode: per_provider
          sub_mode: hashed_user_id
          access_code_validity: minutes=10
          access_token_validity: minutes=60
          refresh_token_validity: days=30
      
      # Application
      - model: authentik_core.application
        identifiers:
          slug: grafana
        attrs:
          name: Grafana
          provider: !Find [authentik_providers_oauth2.oauth2provider, [name, grafana-provider]]
          open_in_new_tab: true
          launch_url: https://grafana.cluster.integratn.tech
          group: Platform Services
          meta_icon: https://grafana.com/static/img/menu/grafana2.svg
          meta_description: Observability & Monitoring Dashboards
          policy_engine_mode: all

  03-default-authentication-flow.yaml: |
    # Authentik Blueprint: Default Authentication Flow
    # Creates a standard authentication flow with username/password
    version: 1
    metadata:
      name: default-authentication-flow
      labels:
        blueprints.goauthentik.io/instantiate: "true"
    entries:
      # Authentication Flow
      - model: authentik_flows.flow
        identifiers:
          slug: default-authentication-flow
        id: flow
        attrs:
          name: Default Authentication Flow
          title: Welcome to the Platform
          designation: authentication
          authentication: require_unauthenticated
          layout: stacked
          denied_action: message_continue
      
      # Stage 2: Password (must come before identification stage that references it)
      - model: authentik_stages_password.passwordstage
        identifiers:
          name: default-authentication-password
        id: password-stage
        attrs:
          backends:
            - authentik.core.auth.InbuiltBackend
            - authentik.core.auth.TokenBackend
          configure_flow: null
          failed_attempts_before_cancel: 5
      
      # Stage 1: Identification (username/email)
      - model: authentik_stages_identification.identificationstage
        identifiers:
          name: default-authentication-identification
        id: identification-stage
        attrs:
          user_fields:
            - username
            - email
          password_stage: !Find [authentik_stages_password.passwordstage, [name, default-authentication-password]]
          sources:
            - !Find [authentik_sources_oauth.oauthsource, [slug, google]]
          show_matched_user: true
          show_source_labels: true
      
      # Stage 3: User Login
      - model: authentik_stages_user_login.userloginstage
        identifiers:
          name: default-authentication-login
        id: user-login-stage
        attrs:
          session_duration: seconds=0
          remember_me_offset: seconds=0
      
      # Flow Stage Bindings
      - model: authentik_flows.flowstagebinding
        identifiers:
          target: !Find [authentik_flows.flow, [slug, default-authentication-flow]]
          stage: !Find [authentik_stages_identification.identificationstage, [name, default-authentication-identification]]
          order: 10
        attrs:
          evaluate_on_plan: true
          re_evaluate_policies: false
          policy_engine_mode: any
          invalid_response_action: retry
      
      - model: authentik_flows.flowstagebinding
        identifiers:
          target: !Find [authentik_flows.flow, [slug, default-authentication-flow]]
          stage: !Find [authentik_stages_password.passwordstage, [name, default-authentication-password]]
          order: 20
        attrs:
          evaluate_on_plan: true
          re_evaluate_policies: false
          policy_engine_mode: any
          invalid_response_action: retry
      
      - model: authentik_flows.flowstagebinding
        identifiers:
          target: !Find [authentik_flows.flow, [slug, default-authentication-flow]]
          stage: !Find [authentik_stages_user_login.userloginstage, [name, default-authentication-login]]
          order: 30
        attrs:
          evaluate_on_plan: true
          re_evaluate_policies: false
          policy_engine_mode: any
          invalid_response_action: retry

  04-google-oauth-source.yaml: |
    # Authentik Blueprint: Google OAuth Source
    # Configures Google as a social login / federation source
    # Callback URL to configure in Google Cloud Console:
    #   https://auth.cluster.integratn.tech/source/oauth/callback/google/
    #
    # Prerequisites in Google Cloud Console:
    #   1. Enable the "Cloud Identity API" at https://console.cloud.google.com/apis/library/cloudidentity.googleapis.com
    #   2. Add the cloud-identity.groups.readonly scope to the OAuth consent screen
    #   3. Add the callback URL above as an authorized redirect URI
    version: 1
    metadata:
      name: google-oauth-source
      labels:
        blueprints.goauthentik.io/instantiate: "true"
    context:
      google_client_id: !Env GOOGLE_CLIENT_ID
      google_client_secret: !Env GOOGLE_CLIENT_SECRET
    entries:
      # Property mapping to sync Google Workspace group memberships
      - model: authentik_sources_oauth.oauthsourcepropertymapping
        identifiers:
          name: "Google Workspace Groups Sync"
        id: google-groups-mapping
        attrs:
          expression: |
            # Fetch the user's Google Workspace group memberships via Cloud Identity API
            email = info.get("email", "")
            access_token = token.get("access_token", "")
            groups = []
            if email and access_token:
                try:
                    response = requests.get(
                        "https://cloudidentity.googleapis.com/v1/groups/-/memberships:searchDirectGroups",
                        params={
                            "query": f"member_key_id=='{email}' && 'cloudidentity.googleapis.com/groups.discussion_forum' in labels",
                            "pageSize": 200,
                        },
                        headers={"Authorization": f"Bearer {access_token}"},
                        timeout=10,
                    )
                    if response.status_code == 200:
                        data = response.json()
                        for membership in data.get("memberships", []):
                            # Use the group display name as the Authentik group name
                            name = membership.get("displayName", "")
                            if name:
                                groups.append(name)
                    else:
                        ak_logger.warning(
                            "Google Groups API error",
                            status=response.status_code,
                            body=response.text[:200],
                        )
                except Exception as e:
                    ak_logger.warning("Google Groups API exception", error=str(e))
            return {"groups": groups}

      # Google OAuth Source
      - model: authentik_sources_oauth.oauthsource
        identifiers:
          slug: google
        id: google-source
        attrs:
          name: Google
          provider_type: google
          consumer_key: !Context google_client_id
          consumer_secret: !Context google_client_secret
          authentication_flow: !Find [authentik_flows.flow, [slug, default-source-authentication]]
          enrollment_flow: !Find [authentik_flows.flow, [slug, default-source-enrollment]]
          user_matching_mode: email_link
          enabled: true
          oidc_well_known_url: "https://accounts.google.com/.well-known/openid-configuration"
          oidc_jwks_url: "https://www.googleapis.com/oauth2/v3/certs"
          additional_scopes: "https://www.googleapis.com/auth/cloud-identity.groups.readonly"
          user_property_mappings:
            - !Find [authentik_sources_oauth.oauthsourcepropertymapping, [name, "Google Workspace Groups Sync"]]