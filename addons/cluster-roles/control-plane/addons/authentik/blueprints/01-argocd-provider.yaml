# Authentik Blueprint: ArgoCD OAuth2 Provider
# Creates OAuth2/OIDC provider for ArgoCD integration
version: 1
metadata:
  name: argocd-provider
  labels:
    blueprints.goauthentik.io/instantiate: "true"
context:
  client_id: !Env ARGOCD_CLIENT_ID
  client_secret: !Env ARGOCD_CLIENT_SECRET
entries:
  # Custom scope mapping for groups (must come before provider that references it)
  - model: authentik_providers_oauth2.scopemapping
    identifiers:
      name: ArgoCD Groups Scope
      scope_name: groups
    id: groups-scope
    attrs:
      expression: |
        return {
          "groups": [group.name for group in user.ak_groups.all()],
        }
  
  # OAuth2/OIDC Provider
  - model: authentik_providers_oauth2.oauth2provider
    identifiers:
      name: argocd-provider
    id: argocd-provider
    attrs:
      authorization_flow: !Find [authentik_flows.flow, [slug, default-authentication-flow]]
      client_type: confidential
      client_id: !Context client_id
      client_secret: !Context client_secret
      redirect_uris: |
        https://argocd.cluster.integratn.tech/auth/callback
        https://argocd.cluster.integratn.tech/api/dex/callback
      signing_key: !Find [authentik_crypto.certificatekeypair, [name, "authentik Self-signed Certificate"]]
      property_mappings:
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, "openid"]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, "email"]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, "profile"]]
        - !Find [authentik_providers_oauth2.scopemapping, [name, "ArgoCD Groups Scope"]]
      include_claims_in_id_token: true
      issuer_mode: per_provider
      sub_mode: hashed_user_id
      access_code_validity: minutes=10
      access_token_validity: minutes=60
      refresh_token_validity: days=30
  
  # Application
  - model: authentik_core.application
    identifiers:
      slug: argocd
    attrs:
      name: ArgoCD
      provider: !Find [authentik_providers_oauth2.oauth2provider, [name, argocd-provider]]
      open_in_new_tab: true
      launch_url: https://argocd.cluster.integratn.tech
      group: Platform Services
      meta_icon: https://cncf-branding.netlify.app/img/projects/argo/icon/color/argo-icon-color.png
      meta_description: GitOps Continuous Delivery
      policy_engine_mode: any
