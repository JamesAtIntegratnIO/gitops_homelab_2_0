# Kratix Values for control-plane clusters

# Disable default BucketStateStore
stateStores: []

# Disable default destinations
destinations: []

# Additional resources for Kratix platform setup
additionalResources:
  
  # ExternalSecret to pull GitHub App credentials from 1Password
  - apiVersion: external-secrets.io/v1beta1
    kind: ExternalSecret
    metadata:
      name: kratix-github-credentials
      namespace: kratix-platform-system
    spec:
      secretStoreRef:
        name: onepassword-store
        kind: ClusterSecretStore
      target:
        name: kratix-github-credentials
        creationPolicy: Owner
      data:
        - secretKey: appID
          remoteRef:
            key: kratix-gitops-statestore
            property: AppID
        - secretKey: installationID
          remoteRef:
            key: kratix-gitops-statestore
            property: InstallID
        - secretKey: privateKey
          remoteRef:
            key: kratix-gitops-statestore
            property: PrivateKey
  
  # GitStateStore pointing to kratix-platform-state repository
  - apiVersion: platform.kratix.io/v1alpha1
    kind: GitStateStore
    metadata:
      name: default
      namespace: kratix-platform-system
    spec:
      authMethod: githubApp
      secretRef:
        name: kratix-github-credentials
        namespace: kratix-platform-system
      url: https://github.com/jamesatintegratnio/kratix-platform-state
      branch: main
      path: clusters

  # PVC for Kratix Git workspace
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: kratix-git-storage
      namespace: kratix-platform-system
    spec:
      accessModes:
        - ReadWriteMany
      resources:
        requests:
          storage: 1Gi
  
  # Destination for the-cluster workload scheduling
  - apiVersion: platform.kratix.io/v1alpha1
    kind: Destination
    metadata:
      name: the-cluster
      namespace: kratix-platform-system
      labels:
        environment: production
        cluster-role: control-plane
        capability.vcluster: "true"
    spec:
      stateStoreRef:
        name: default
        kind: GitStateStore
      path: the-cluster
      strictMatchLabels: false
  
  # ArgoCD Application to reconcile state from kratix-platform-state repo
  - apiVersion: argoproj.io/v1alpha1
    kind: Application
    metadata:
      name: kratix-state-reconciler
      namespace: argocd
      finalizers:
        - resources-finalizer.argocd.argoproj.io
    spec:
      project: platform
      source:
        repoURL: https://github.com/jamesatintegratnio/kratix-platform-state
        targetRevision: main
        path: clusters/the-cluster
        directory:
          recurse: true
      destination:
        server: https://kubernetes.default.svc
        namespace: kratix-platform-system
      syncPolicy:
        automated:
          selfHeal: true
          prune: true
        syncOptions:
          - CreateNamespace=true
      ignoreDifferences:
        - group: batch
          kind: Job
          jsonPointers:
            - /spec
            - /status
        - group: argoproj.io
          kind: Application
          namespace: argocd
          jsonPointers:
            - /metadata/annotations/argocd.argoproj.io~1tracking-id
            - /metadata/annotations/kubectl.kubernetes.io~1last-applied-configuration
        - group: argoproj.io
          kind: AppProject
          namespace: argocd
          jsonPointers:
            - /metadata/annotations/argocd.argoproj.io~1tracking-id
            - /metadata/annotations/kubectl.kubernetes.io~1last-applied-configuration
            - /metadata/labels
        - group: platform.integratn.tech
          kind: ArgoCDApplication
          namespace: platform-requests
          jsonPointers:
            - /metadata/annotations/argocd.argoproj.io~1tracking-id
            - /metadata/annotations/kubectl.kubernetes.io~1last-applied-configuration
            - /metadata/labels
        - group: platform.integratn.tech
          kind: ArgoCDProject
          namespace: platform-requests
          jsonPointers:
            - /metadata/annotations/argocd.argoproj.io~1tracking-id
            - /metadata/annotations/kubectl.kubernetes.io~1last-applied-configuration
            - /metadata/labels
        - group: platform.integratn.tech
          kind: ArgoCDClusterRegistration
          namespace: platform-requests
          jsonPointers:
            - /metadata/annotations/argocd.argoproj.io~1tracking-id
            - /metadata/annotations/kubectl.kubernetes.io~1last-applied-configuration
            - /metadata/labels

  # --- Kratix Observability ---

  # ServiceAccount for Prometheus to authenticate to the metrics endpoint
  - apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: kratix-metrics-reader
      namespace: kratix-platform-system
      labels:
        app.kubernetes.io/part-of: kratix

  # Secret to generate a long-lived token for the ServiceAccount
  - apiVersion: v1
    kind: Secret
    metadata:
      name: kratix-metrics-reader-token
      namespace: kratix-platform-system
      annotations:
        kubernetes.io/service-account.name: kratix-metrics-reader
    type: kubernetes.io/service-account-token

  # ClusterRole granting access to metrics endpoint via kube-rbac-proxy
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: kratix-metrics-reader
    rules:
      - nonResourceURLs: ["/metrics"]
        verbs: ["get"]

  # Bind the ServiceAccount to the ClusterRole
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: kratix-metrics-reader
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: kratix-metrics-reader
    subjects:
      - kind: ServiceAccount
        name: kratix-metrics-reader
        namespace: kratix-platform-system

  # ServiceMonitor for Kratix controller manager metrics
  - apiVersion: monitoring.coreos.com/v1
    kind: ServiceMonitor
    metadata:
      name: kratix-controller-manager
      namespace: kratix-platform-system
      labels:
        app.kubernetes.io/part-of: kratix
    spec:
      selector:
        matchLabels:
          control-plane: controller-manager
      namespaceSelector:
        matchNames:
          - kratix-platform-system
      endpoints:
        - port: https
          scheme: https
          tlsConfig:
            insecureSkipVerify: true
          bearerTokenSecret:
            name: kratix-metrics-reader-token
            key: token
          interval: 30s
          metricRelabelings:
            - action: keep
              sourceLabels: [__name__]
              regex: kratix_.*|workqueue_.*|controller_runtime_.*|process_.*|go_.*

  # PrometheusRule for Kratix platform alerts
  - apiVersion: monitoring.coreos.com/v1
    kind: PrometheusRule
    metadata:
      name: kratix-platform-alerts
      namespace: kratix-platform-system
      labels:
        app.kubernetes.io/part-of: kratix
    spec:
      groups:
        - name: kratix.pipeline
          interval: 30s
          rules:
            - alert: KratixPipelineFailed
              expr: |
                kube_pod_status_phase{namespace="platform-requests", phase="Failed"} > 0
              for: 5m
              labels:
                severity: warning
                component: kratix
              annotations:
                summary: "Kratix pipeline pod failed"
                description: "Pipeline pod {{ $labels.pod }} in namespace {{ $labels.namespace }} has been in Failed state for more than 5 minutes."
            - alert: KratixPipelineStuck
              expr: |
                kube_pod_status_phase{namespace="platform-requests", phase=~"Pending|Running"}
                * on(pod, namespace) group_left()
                (time() - kube_pod_start_time{namespace="platform-requests"} > 900)
              for: 5m
              labels:
                severity: warning
                component: kratix
              annotations:
                summary: "Kratix pipeline pod stuck"
                description: "Pipeline pod {{ $labels.pod }} has been running for more than 15 minutes."
        - name: kratix.workplacement
          interval: 30s
          rules:
            - alert: KratixWorkPlacementFailure
              expr: |
                increase(kratix_workplacement_writes_total{result="failure"}[5m]) > 0
              for: 0m
              labels:
                severity: critical
                component: kratix
              annotations:
                summary: "Kratix WorkPlacement write failure"
                description: "WorkPlacement write failed for promise {{ $labels.promise }}, resource {{ $labels.resource }} to destination {{ $labels.destination }}."
            - alert: KratixResourceUnscheduled
              expr: |
                increase(kratix_workplacement_outcomes_total{result="unscheduled"}[10m]) > 0
              for: 5m
              labels:
                severity: critical
                component: kratix
              annotations:
                summary: "Kratix resource unscheduled"
                description: "Resource {{ $labels.resource }} from promise {{ $labels.promise }} could not be scheduled to any destination."
        - name: kratix.statestore
          interval: 60s
          rules:
            - alert: KratixStateReconcilerOutOfSync
              expr: |
                argocd_app_info{name="kratix-state-reconciler", sync_status!="Synced"} == 1
              for: 10m
              labels:
                severity: warning
                component: kratix
              annotations:
                summary: "Kratix state reconciler out of sync"
                description: "The kratix-state-reconciler ArgoCD application has been out of sync for more than 10 minutes."
            - alert: KratixStateReconcilerDegraded
              expr: |
                argocd_app_info{name="kratix-state-reconciler", health_status!="Healthy"} == 1
              for: 5m
              labels:
                severity: critical
                component: kratix
              annotations:
                summary: "Kratix state reconciler unhealthy"
                description: "The kratix-state-reconciler ArgoCD application health is {{ $labels.health_status }}."
