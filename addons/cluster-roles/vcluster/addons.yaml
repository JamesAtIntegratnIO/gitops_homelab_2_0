argocd:
  ignoreDifferences:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      jqPathExpressions:
        - .status
      jsonPointers:
        - /spec/rules/0/backendRefs/0/group
        - /spec/rules/0/backendRefs/0/kind
        - /spec/rules/0/backendRefs/0/weight
        - /spec/parentRefs/0/group
        - /spec/parentRefs/0/kind
  valuesObject:
    global:
      domain: '{{ printf "argocd.%s.%s" .metadata.labels.cluster_name (index .metadata.annotations "platform.integratn.tech/base-domain") }}'
    configs:
      params:
        server.insecure: true
        server.url: 'https://{{ printf "argocd.%s.%s" .metadata.labels.cluster_name (index .metadata.annotations "platform.integratn.tech/base-domain") }}'
    extraObjects:
      - apiVersion: gateway.networking.k8s.io/v1
        kind: HTTPRoute
        metadata:
          name: argocd
          namespace: argocd
        spec:
          parentRefs:
            - name: nginx-gateway
              namespace: nginx-gateway
              sectionName: https
          hostnames:
            - '{{ printf "argocd.%s.%s" .metadata.labels.cluster_name (index .metadata.annotations "platform.integratn.tech/base-domain") }}'
          rules:
            - matches:
                - path:
                    type: PathPrefix
                    value: /
              backendRefs:
                - name: argo-cd-argocd-server
                  port: 80
      - apiVersion: gateway.networking.k8s.io/v1
        kind: HTTPRoute
        metadata:
          name: argocd-http-redirect
          namespace: argocd
        spec:
          parentRefs:
            - name: nginx-gateway
              namespace: nginx-gateway
              sectionName: http
          hostnames:
            - '{{ printf "argocd.%s.%s" .metadata.labels.cluster_name (index .metadata.annotations "platform.integratn.tech/base-domain") }}'
          rules:
            - filters:
                - type: RequestRedirect
                  requestRedirect:
                    scheme: https
                    statusCode: 301
              matches:
                - path:
                    type: PathPrefix
                    value: /

nginx-gateway-fabric:
  ignoreDifferences:
    - group: gateway.networking.k8s.io
      kind: Gateway
      jqPathExpressions:
        - .status
  valuesObject:
    gateways:
      - name: nginx-gateway
        namespace: nginx-gateway
        labels:
          app: nginx-gateway-fabric
        annotations:
          cert-manager.io/cluster-issuer: letsencrypt-prod
          argocd.argoproj.io/compare-options: IgnoreExtraneous
          argocd.argoproj.io/sync-options: Prune=false
        spec:
          gatewayClassName: nginx
          listeners:
            - name: http
              port: 80
              protocol: HTTP
              hostname: '{{ printf "*.%s.%s" .metadata.labels.cluster_name (index .metadata.annotations "platform.integratn.tech/base-domain") }}'
              allowedRoutes:
                namespaces:
                  from: All
            - name: https
              port: 443
              protocol: HTTPS
              hostname: '{{ printf "*.%s.%s" .metadata.labels.cluster_name (index .metadata.annotations "platform.integratn.tech/base-domain") }}'
              tls:
                mode: Terminate
                certificateRefs:
                  - group: ""
                    kind: Secret
                    name: 'wildcard-{{ .metadata.labels.cluster_name }}-{{ index .metadata.annotations "platform.integratn.tech/base-domain-sanitized" }}-tls'
              allowedRoutes:
                namespaces:
                  from: All

external-dns:
  additionalResources:
    type: manifests
    path: clusters
    manifestPath: addons/external-dns-resources
  valuesObject:
    logLevel: info
    domainFilters:
      - '{{ index .metadata.annotations "platform.integratn.tech/base-domain" }}'
    txtOwnerId: '{{ .metadata.labels.cluster_name }}'
    txtPrefix: '{{ printf "%s-" .metadata.labels.cluster_name }}'
    extraArgs:
      - --gateway-name=nginx-gateway

cert-manager:
  valuesObject:
    extraObjects:
      - |
        apiVersion: external-secrets.io/v1beta1
        kind: ExternalSecret
        metadata:
          name: cloudflare-api-key
          namespace: cert-manager
        spec:
          refreshInterval: 1h
          secretStoreRef:
            kind: ClusterSecretStore
            name: onepassword-store
          target:
            name: cloudflare-api-key
            creationPolicy: Owner
          data:
            - secretKey: CF_API_KEY
              remoteRef:
                key: cloudflare-api-key
                property: CF_API_KEY
                conversionStrategy: Default
                decodingStrategy: None
                metadataPolicy: None
            - secretKey: CF_API_EMAIL
              remoteRef:
                key: cloudflare-api-key
                property: CF_API_EMAIL
                conversionStrategy: Default
                decodingStrategy: None
                metadataPolicy: None
      - |
        apiVersion: cert-manager.io/v1
        kind: ClusterIssuer
        metadata:
          name: letsencrypt-prod
          labels:
            integratn.tech/cluster-issuer: letsencrypt-prod
        spec:
          acme:
            server: https://acme-v02.api.letsencrypt.org/directory
            email: james@integratn.io
            privateKeySecretRef:
              name: letsencrypt-prod
            solvers:
              - selector:
                  dnsZones:
                    - {{ index .metadata.annotations "platform.integratn.tech/base-domain" }}
                dns01:
                  cloudflare:
                    email: james@integratn.io
                    apiKeySecretRef:
                      name: cloudflare-api-key
                      key: CF_API_KEY
      - |
        apiVersion: cert-manager.io/v1
        kind: Certificate
        metadata:
          name: wildcard-{{ .metadata.labels.cluster_name }}-{{ index .metadata.annotations "platform.integratn.tech/base-domain-sanitized" }}
          namespace: nginx-gateway
        spec:
          secretName: wildcard-{{ .metadata.labels.cluster_name }}-{{ index .metadata.annotations "platform.integratn.tech/base-domain-sanitized" }}-tls
          issuerRef:
            name: letsencrypt-prod
            kind: ClusterIssuer
          dnsNames:
            - '*.{{ .metadata.labels.cluster_name }}.{{ index .metadata.annotations "platform.integratn.tech/base-domain" }}'
      - |
        apiVersion: gateway.networking.k8s.io/v1beta1
        kind: ReferenceGrant
        metadata:
          name: allow-httproutes-from-all
          namespace: nginx-gateway
          annotations:
            argocd.argoproj.io/compare-options: IgnoreExtraneous
            argocd.argoproj.io/sync-options: Prune=false
        spec:
          from:
            - group: gateway.networking.k8s.io
              kind: HTTPRoute
              namespace: argocd
          to:
            - group: ""
              kind: Service
            - group: gateway.networking.k8s.io
              kind: Gateway
