global:
  domain: argocd.cluster.integratn.tech

configs:
  params:
    server.insecure: true
    server.url: https://argocd.cluster.integratn.tech
  
  cm:
    # Authentik OIDC configuration
    oidc.config: |
      name: Authentik
      issuer: https://auth.cluster.integratn.tech/application/o/argocd/
      clientID: $argocd-oidc-config:client-id
      clientSecret: $argocd-oidc-config:client-secret
      requestedScopes:
        - openid
        - profile
        - email
        - groups
    # Ignore container resource drift â€” VPA Auto mode manages requests/limits
    resource.customizations.ignoreDifferences.apps_Deployment: |
      jqPathExpressions:
        - .spec.template.spec.containers[].resources
        - .spec.template.spec.initContainers[]?.resources
    resource.customizations.ignoreDifferences.apps_StatefulSet: |
      jqPathExpressions:
        - .spec.template.spec.containers[].resources
        - .spec.template.spec.initContainers[]?.resources
    resource.customizations.ignoreDifferences.apps_DaemonSet: |
      jqPathExpressions:
        - .spec.template.spec.containers[].resources
        - .spec.template.spec.initContainers[]?.resources
    # Custom health check for ApplicationSet (ArgoCD doesn't include one by default)
    resource.customizations.health.argoproj.io_ApplicationSet: |
      hs = {}
      hs.status = "Healthy"
      hs.message = "ApplicationSet is running"
      return hs
  
  rbac:
    policy.csv: |
      # Default policy: read-only for authenticated users
      p, role:readonly, applications, get, */*, allow
      p, role:readonly, certificates, get, *, allow
      p, role:readonly, clusters, get, *, allow
      p, role:readonly, repositories, get, *, allow
      p, role:readonly, projects, get, *, allow
      p, role:readonly, accounts, get, *, allow
      p, role:readonly, gpgkeys, get, *, allow
      g, role:readonly, role:readonly
      
      # Map Authentik Admins group to ArgoCD admin role
      g, authentik Admins, role:admin

dex:
  enabled: false

server:
  service:
    annotations:
      metallb.universe.tf/loadBalancerIPs: 10.0.4.201

extraObjects:
  - apiVersion: gateway.networking.k8s.io/v1
    kind: HTTPRoute
    metadata:
      name: argocd
      namespace: argocd
    spec:
      parentRefs:
        - name: nginx-gateway
          namespace: nginx-gateway
          sectionName: https
      hostnames:
        - argocd.cluster.integratn.tech
      rules:
        - matches:
            - path:
                type: PathPrefix
                value: /
          backendRefs:
            - name: argo-cd-argocd-server
              port: 80
  - apiVersion: gateway.networking.k8s.io/v1
    kind: HTTPRoute
    metadata:
      name: argocd-http-redirect
      namespace: argocd
    spec:
      parentRefs:
        - name: nginx-gateway
          namespace: nginx-gateway
          sectionName: http
      hostnames:
        - argocd.cluster.integratn.tech
      rules:
        - filters:
            - type: RequestRedirect
              requestRedirect:
                scheme: https
                statusCode: 301
          matches:
            - path:
                type: PathPrefix
                value: /